---
tags:
  - ä¸ªäººç¬”è®°
  - æ­£åœ¨åš
---

# ğŸ“’ é«˜æ€§èƒ½ç½‘ç»œ

!!! abstract

    éšç€ AI çš„å‘å±•å’Œæ•°æ®ä¸­å¿ƒè§„æ¨¡çš„ä¸æ–­æ‰©å¤§ï¼Œé«˜æ€§èƒ½ç½‘ç»œçš„éœ€æ±‚æ—¥ç›Šå¢é•¿ã€‚æœ¬ç¯‡ç¬”è®°æ˜¯å¯¹é«˜æ€§èƒ½ç½‘ç»œæ–¹å‘çš„ç»¼è¿°ï¼ŒåŒ…æ‹¬ RDMAã€DPDKã€RoCE ç­‰æŠ€æœ¯ã€‚

    æˆ‘ä»¬å°†ï¼š

    - ä»ç†Ÿæ‚‰çš„ä¼ ç»Ÿç½‘ç»œæ ˆå¼€å§‹ï¼Œåˆ†æå…¶ä¸è¶³ä¹‹å¤„ã€‚
    - ä»‹ç» RDMA åŸºæœ¬æ¦‚å¿µï¼Œå¹¶é€šè¿‡ IB Verbs ç¼–ç¨‹å®è·µã€‚
    - æ¦‚è§ˆ Linux å†…æ ¸ä¸­çš„ RDMA å­ç³»ç»Ÿ `rdma_core` æºç ã€‚
    - äº†è§£ RDMA çš„ä¸¤ç§å®ç°ï¼šInfiniBand å’Œ RoCEã€‚
    - å¼•å…¥ DPDK å’Œ SPDKï¼Œè®¨è®ºå…¶ä¸ RDMA çš„å…³ç³»ã€‚

## ä¼ ç»Ÿç½‘ç»œæ ˆçš„ä¸è¶³

!!! quote

    - [ofi-guide/OFIGuide.md at master Â· ofiwg/ofi-guide](https://github.com/ofiwg/ofi-guide/blob/master/OFIGuide.md)

### Non-blocking Socket

!!! quote

    - [:simple-github: holmofy/echo-server](https://github.com/holmofy/echo-server)

åœ¨è¯¾å ‚ä¸Šï¼Œæˆ‘ä»¬å­¦ä¹ è¿‡ Socket ç¼–ç¨‹çš„åŸºæœ¬æ–¹æ³•ã€‚åœ¨å®è·µä¸­ï¼Œæ›´å¤šåº”ç”¨ä½¿ç”¨ non-blocking socketï¼š

```c
/* Example server code flow to initiate listen */
struct addrinfo *ai, hints;
int listen_fd;

memset(&hints, 0, sizeof hints);
hints.ai_socktype = SOCK_STREAM;
hints.ai_flags = AI_PASSIVE;
getaddrinfo(NULL, "7471", &hints, &ai);

listen_fd = socket(ai->ai_family, SOCK_STREAM, 0);
bind(listen_fd, ai->ai_addr, ai->ai_addrlen);
freeaddrinfo(ai);

fcntl(listen_fd, F_SETFL, O_NONBLOCK);
listen(listen_fd, 128);

/* Example server code flow to accept a connection */
struct pollfd fds;
int server_fd;

fds.fd = listen_fd;
fds.events = POLLIN;

poll(&fds, -1);

server_fd = accept(listen_fd, NULL, 0);
fcntl(server_fd, F_SETFL, O_NONBLOCK);

/* Example of server receiving data from client */
struct pollfd fds;
size_t offset, size, ret;
char buf[4096];

fds.fd = server_fd;
fds.events = POLLIN;

size = sizeof(buf);
for (offset = 0; offset < size; ) {
    poll(&fds, -1);

    ret = recv(client_fd, buf + offset, size - offset, 0);
    offset += ret;
}
```

åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œnon-blocking socket æ˜¯å¿…ä¸å¯å°‘çš„ï¼š

- **å¹¶å‘å’Œå“åº”æ€§ï¼š** ç­‰å¾…ç½‘ç»œæ“ä½œæ—¶å¯ä»¥å¤„ç†å…¶ä»–ä»»åŠ¡ï¼Œå•ä¸ªçº¿ç¨‹èƒ½å¤Ÿå¤„ç†å¤šä¸ªè¿æ¥ã€‚
- **èµ„æºåˆ©ç”¨ç‡ï¼š** é€šè¿‡ `select` å’Œ `poll` ç­‰ I/O å¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œé«˜æ•ˆå¤„ç†å¤šä¸ªè¿æ¥ã€‚ä¸é˜»å¡å¼æ¨¡å‹ä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ç›¸æ¯”ï¼Œnon-blocking socket å‡å°‘äº†çº¿ç¨‹å¼€é”€ã€‚

### Socket çš„ä¸è¶³

åœ¨åˆ†æä¸è¶³å‰ï¼Œé¦–å…ˆè‚¯å®š Socket çš„ä¸¤å¤§ä¼˜ç‚¹ï¼š

- **é€šç”¨æ€§ï¼š** é€‚ç”¨äºå„ç§ç½‘ç»œè®¾å¤‡å’Œåè®®ã€‚
- **æ˜“ç”¨æ€§ï¼š** ç¼–ç¨‹ç®€å•ï¼Œè¿™æ˜¯éå¸¸é‡è¦çš„ä¸€ç‚¹ã€‚æä¾›æ›´é«˜æ€§èƒ½çš„ API éƒ½æ¯” Socket æ›´éš¾ç¼–ç¨‹ã€‚ç±»æ¯” C/C++ ä¸æ±‡ç¼–ï¼Œå¯¹äºå¤§å¤šæ•°ç¨‹åºå‘˜æ¥è¯´ï¼Œç¼–å†™ C/C++ ç¨‹åºçš„æ€§èƒ½æ›´é«˜ã€‚å› æ­¤é€‰æ‹© Socket ä¹‹å¤–çš„ API æ—¶ï¼Œéœ€è¦æœ‰æ˜ç¡®çš„éœ€æ±‚ã€‚

ä½† Socket æ— æ³•æ»¡è¶³é«˜æ€§èƒ½ç½‘ç»œçš„ä¸‰ç‚¹éœ€æ±‚ï¼š

- **é¿å…å†…å­˜æ‹·è´ï¼š** æˆ‘ä»¬åˆ†åˆ«è€ƒè™‘å‘é€å’Œæ¥æ”¶ç«¯çš„å¤„ç†è¿‡ç¨‹

    - **å‘é€ç«¯ï¼š** `send()` è¿”å›æ—¶ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥é‡ç”¨ç¼“å†²åŒºã€‚ç„¶è€Œåªæœ‰å¯¹æ–¹ ACKï¼Œæ‰èƒ½ç¡®ä¿æ•°æ®æˆåŠŸé€è¾¾ã€‚ç½‘ç»œæ ˆæœ‰ä¸¤ç§é€‰æ‹©ï¼šé˜»å¡ï¼Œç­‰å¾… ACK è¿”å›ï¼›ç«‹å³è¿”å›ï¼Œä½†éœ€è¦å°†æ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œç­‰å¾… ACK é‡Šæ”¾ã€‚
    - **æ¥æ”¶ç«¯ï¼š** ç½‘ç»œé€‚é…å™¨æ”¶åˆ°æ•°æ®åŒ…åæ”¾å…¥å†…æ ¸ç¼“å†²åŒºï¼Œå¦åˆ™ä¸¢å¼ƒã€‚è¦é¿å…æ‹·è´ï¼Œå”¯ä¸€çš„æ–¹æ³•å°±æ˜¯åœ¨ `send()` å‰è°ƒç”¨ `recv()`ï¼Œç„¶è€Œè¿™ä¼šé˜»å¡æ¥æ”¶ç«¯ï¼Œä¸”åœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹æ— æ³•æ»¡è¶³ã€‚

    å¯ä»¥çœ‹åˆ°ï¼Œæ“ä½œç³»ç»Ÿç½‘ç»œæ ˆä¸å¾—ä¸ç»´æŠ¤ç¼“å†²åŒºï¼Œé€ æˆæ•°æ®åœ¨åº”ç”¨ç¨‹åºå’Œç½‘ç»œæ ˆä¹‹é—´çš„æ‹·è´ã€‚

    å¦‚æœèƒ½å¤Ÿæ”¯æŒå°†æ•°æ®ç›´æ¥å†™å…¥ç‰¹å®šçš„å†…å­˜åŒºåŸŸï¼Œå°†æ˜¾è‘—æå‡æŸäº›åº”ç”¨çš„æ€§èƒ½ã€‚ä¾‹å¦‚ï¼šæ•°æ®åº“å¯èƒ½å¸Œæœ›å°†æ”¶åˆ°çš„è®°å½•åˆå¹¶åˆ°è¡¨ä¸­ã€‚

- **å¼‚æ­¥æ“ä½œï¼š** Socket API ä»¥åŒæ­¥æ–¹å¼è¿è¡Œã€‚è¦ä½¿ç”¨ Socket è¿›è¡Œå¼‚æ­¥æ“ä½œï¼Œå°±ä¼šäº§ç”Ÿé¢å¤–çš„æ‹·è´ã€‚

- **ç›´æ¥è®¿é—®ç¡¬ä»¶ï¼š**

---

å¾…æ•´ç†

## RDMA åŸºæœ¬æ¦‚å¿µ

!!! quote

    - [RDMA Tutorial - LSDS](https://www.doc.ic.ac.uk/~jgiceva/teaching/ssc18-rdma.pdf)
    - [Verbs programming tutorial](https://www.csm.ornl.gov/workshops/openshmem2014/documents/presentations_and_tutorials/Tutorials/Verbs%20programming%20tutorial-final.pdf)

### æ³¨å†Œå†…å­˜åŒºåŸŸ

RDMA é€šä¿¡å‰ï¼Œéœ€è¦å…ˆæ³¨å†Œå†…å­˜åŒºåŸŸ **MRï¼ˆmemory regionï¼‰**ï¼Œä¾› RDMA è®¾å¤‡è®¿é—®ï¼š

- å†…å­˜é¡µé¢å¿…é¡»è¢« Pin ä½ä¸å¯æ¢å‡ºã€‚
- æ³¨å†Œæ—¶è·å¾— **L_Keyï¼ˆlocal keyï¼‰** å’Œ **R_Keyï¼ˆremote keyï¼‰**ã€‚å‰è€…ç”¨äºæœ¬åœ°è®¿é—®ï¼Œåè€…ç”¨äºè¿œç¨‹è®¿é—®ã€‚

#### äº¤æ¢ä¿¡æ¯

åœ¨è¿›è¡Œ RDMA é€šä¿¡å‰ï¼Œé€šä¿¡åŒæ–¹éœ€è¦äº¤æ¢ R_Key å’Œ QP ç­‰ä¿¡æ¯ã€‚å¯ä»¥å…ˆé€šè¿‡ä»¥å¤ªç½‘å»ºç«‹ TCP è¿æ¥ï¼Œæˆ–è€…ä½¿ç”¨ `rdma_cm` ç®¡ç† RDMA è¿æ¥ã€‚

#### å¼‚æ­¥é€šä¿¡

RDMA åŸºäºä¸‰ä¸ªé˜Ÿåˆ—è¿›è¡Œ**å¼‚æ­¥**é€šä¿¡ï¼š

- Sendã€Receive é˜Ÿåˆ—ç”¨äº**è°ƒåº¦**å·¥ä½œï¼ˆworkï¼‰ã€‚è¿™ä¸¤ä¸ªé˜Ÿåˆ—ä¹Ÿåˆç§°ä¸º **Queue Pairï¼ˆQPï¼‰**ã€‚
- Completion é˜Ÿåˆ—ç”¨äº**é€šçŸ¥**å·¥ä½œå®Œæˆã€‚

RDMA é€šä¿¡æµç¨‹å¦‚ä¸‹ï¼š

- åº”ç”¨ç¨‹åºå°† **WRï¼ˆwork requestï¼Œä¹Ÿç§°ä¸º work queue elementï¼‰**æ”¾å…¥ï¼ˆpostï¼‰åˆ° Send æˆ– Receive é˜Ÿåˆ—ã€‚
- WR ä¸­å«æœ‰ **SGEï¼ˆScatter/Gather Elementsï¼‰**ï¼ŒæŒ‡å‘ RDMA è®¾å¤‡å¯ä»¥è®¿é—®çš„ä¸€å— MR åŒºåŸŸã€‚åœ¨ Send é˜Ÿåˆ—ä¸­æŒ‡å‘å‘é€æ•°æ®ï¼ŒReceive é˜Ÿåˆ—ä¸­æŒ‡å‘æ¥æ”¶æ•°æ®ã€‚
- WR å®Œæˆåï¼ŒRDMA è®¾å¤‡åˆ›å»º **WCï¼ˆwork completionï¼Œä¹Ÿç§°ä¸º completion queue elementï¼‰**æ”¾å…¥ Completion é˜Ÿåˆ—ã€‚åº”ç”¨å‘é€‚é…å™¨è½®è¯¢ï¼ˆpollï¼‰Completion é˜Ÿåˆ—ï¼Œè·å– WCã€‚

å¯¹äºä¸€ä¸ªåº”ç”¨ï¼ŒQP å’Œ CQ å¯ä»¥æ˜¯å¤šå¯¹ä¸€çš„å…³ç³»ã€‚QPã€CQ å’Œ MR éƒ½å®šä¹‰åœ¨ä¸€ä¸ª **Protection Domainï¼ˆPDï¼‰** ä¸­ã€‚

<figure markdown="span">
    ![rdma_queue_pair](hpn.assets/rdma_queue_pair.webp){ width=40% align=center}
    <figcaption>
    RDMA é€šä¿¡é˜Ÿåˆ—
    <br /><small>
    [InfiniBand Technology Overview - SNIA](https://www.snia.org/sites/default/education/tutorials/2008/spring/networking/Goldenberg-D_InfiniBand_Technology_Overview.pdf)
</small></figcaption></figure>

#### è®¿å­˜æ¨¡å¼

RDMA æ”¯æŒä¸¤ç§è®¿å­˜æ¨¡å¼ï¼š

- å•è¾¹ï¼ˆone-sidedï¼‰ï¼š**readã€writeã€atomic** æ“ä½œã€‚
    - è¢«åŠ¨æ–¹æ³¨å†Œä¸€å—å†…å­˜åŒºåŸŸï¼Œç„¶åå°†æ§åˆ¶æƒäº¤ç»™ä¸»åŠ¨æ–¹ï¼›ä¸»åŠ¨æ–¹ä½¿ç”¨ RDMA Read/Write æ“ä½œè¿™å—å†…å­˜åŒºåŸŸã€‚
    - **è¢«åŠ¨æ–¹ä¸ä¼šä½¿ç”¨ CPU èµ„æº**ï¼Œä¸ä¼šçŸ¥é“ readã€write æ“ä½œçš„å‘ç”Ÿã€‚
    - WR å¿…é¡»åŒ…å«è¿œç«¯çš„**è™šæ‹Ÿå†…å­˜åœ°å€**å’Œ **R_key**ï¼Œä¸»åŠ¨æ–¹å¿…é¡»æå‰çŸ¥é“è¿™äº›ä¿¡æ¯ã€‚
- åŒè¾¹ï¼ˆtwo-sidedï¼‰ï¼š**sendã€receive** æ“ä½œã€‚
    - æºå’Œç›®çš„åº”ç”¨éƒ½éœ€è¦ä¸»åŠ¨å‚ä¸é€šä¿¡ã€‚åŒæ–¹éƒ½éœ€è¦åˆ›å»º QP å’Œ CQã€‚
    - ä¸€æ–¹å‘é€ receiveï¼Œåˆ™å¯¹ç«¯éœ€è¦å‘é€ sendï¼Œæ¥æ¶ˆè€—ï¼ˆconsumeï¼‰è¿™ä¸ª receiveã€‚
    - æ¥æ”¶æ–¹éœ€è¦å…ˆå‘é€è‡ªå·±æ¥æ”¶çš„æ•°æ®ç»“æ„ï¼Œç„¶åå‘é€ç«¯æŒ‰ç…§è¿™ä¸ªæ•°æ®ç»“æ„å‘é€æ•°æ®ã€‚è¿™æ„å‘³ç€æ¥æ”¶æ–¹çš„ç¼“å†²åŒºå’Œæ•°æ®ç»“æ„å¯¹å‘é€æ–¹ä¸å¯è§ã€‚

åœ¨å•ä¸ªè¿æ¥ä¸­ï¼Œå¯ä»¥**æ··ç”¨å¹¶åŒ¹é…ï¼ˆmix and matchï¼‰**è¿™ä¸¤ç§æ¨¡å¼ã€‚

#### å†…æ ¸æ—è·¯

RDMA æä¾›å†…æ ¸æ—è·¯ï¼ˆkernel bypassï¼‰åŠŸèƒ½ï¼š

- åŸå…ˆç”± CPU è´Ÿè´£çš„åˆ†ç‰‡ã€å¯é æ€§ã€é‡ä¼ ç­‰åŠŸèƒ½ï¼Œç°åœ¨ç”±é€‚é…å™¨è´Ÿè´£ã€‚
- RDMA ç¡¬ä»¶å’Œé©±åŠ¨å…·æœ‰ç‰¹æ®Šçš„è®¾è®¡ï¼Œå¯ä»¥å®‰å…¨åœ°å°†ç¡¬ä»¶æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œè®©åº”ç”¨ç¨‹åºç›´æ¥è®¿é—®ç¡¬ä»¶èµ„æºã€‚
- æ•°æ®é€šè·¯ç›´æ¥ä»ç”¨æˆ·ç©ºé—´åˆ°ç¡¬ä»¶ï¼Œä½†æ§åˆ¶é€šè·¯ä»ç„¶é€šè¿‡å†…æ ¸ï¼ŒåŒ…æ‹¬èµ„æºç®¡ç†ã€çŠ¶æ€ç›‘æ§å’Œæ¸…ç†ç­‰ã€‚ä¿è¯ç³»ç»Ÿå®‰å…¨ç¨³å®šã€‚

!!! question

    äº‹å®ä¸Šï¼Œé€šä¿¡åŒæ–¹çš„ QP è¢«ç›´æ¥æ˜ å°„åˆ°äº†ç”¨æˆ·ç©ºé—´ï¼Œå› æ­¤ç›¸å½“äºç›´æ¥è®¿é—®å¯¹æ–¹çš„å†…å­˜ã€‚

    å¦‚æœä½ å¯¹æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶é©±åŠ¨æœ‰ä¸€äº›äº†è§£ï¼Œä¸å¦¨æƒ³ä¸€æƒ³ä¸‹é¢çš„é—®é¢˜ï¼š

    - å¦‚ä½•æ‰èƒ½è®©åº”ç”¨ç¨‹åºç›´æ¥è®¿é—®ç¡¬ä»¶èµ„æºï¼ŒåŒæ—¶å®ç°æ“ä½œç³»ç»Ÿæä¾›çš„åº”ç”¨éš”ç¦»å’Œä¿æŠ¤å‘¢ï¼Ÿ
    - å¦‚æœåœ¨ä¸¤ä¸ªç‹¬ç«‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ï¼ˆå¯èƒ½åœ¨ä¸åŒç‰©ç†æœºã€ä¸åŒæ¶æ„ä¸Šï¼‰ä¹‹é—´å»ºç«‹è”ç³»ï¼Ÿ

### RDMA ç¼–ç¨‹

å…·ä½“åœ°è¯´ï¼Œå­¦ä¹ çš„æ˜¯ `libibverbs` åº“ã€‚

!!! quote

    - é˜…è¯» [For the RDMA novice: libfabric, libibverbs, InfiniBand, OFED, MOFED? â€” Rohit Zambre](https://www.rohitzambre.com/blog/2018/2/9/for-the-rdma-novice-libfabric-libibverbs-infiniband-ofed-mofed)ï¼Œäº†è§£è¿™äº›è½¯ä»¶åŒ…çš„å…³ç³»ã€‚
    - [RDMA Aware Networks Programming User Manual - NVIDIA Docs](https://docs.nvidia.com/networking/display/rdmaawareprogrammingv17)ï¼šä½œä¸ºæ‰‹å†Œä½¿ç”¨ã€‚åŒ…å« RDMA æ¶æ„æ¦‚è¿°å’Œ ibverbã€rdma_cm ç­‰ API æ–‡æ¡£ã€‚**è¯¥æ–‡æ¡£ç¬¬å…«ç« åŒ…å«äº†å„å±‚æ¬¡ API ç¼–ç¨‹çš„ä¾‹å­ï¼Œå…·æœ‰æ¯”è¾ƒè¯¦ç»†çš„æ³¨é‡Šï¼Œé€‚åˆåˆå­¦è€…å­¦ä¹ ã€‚**

æ¥ä¸‹æ¥é€šè¿‡ NVIDIA Docs æä¾›çš„ä¾‹å­æ¥å­¦ä¹  RDMA ç¼–ç¨‹ã€‚

## IB Verbs ç¼–ç¨‹

!!! quote

    - é˜…è¯» [InfiniBand: An Introduction + Simple IB verbs program with RDMA Write - Service Engineering (ICCLab & SPLab)](https://blog.zhaw.ch/icclab/infiniband-an-introduction-simple-ib-verbs-program-with-rdma-write/)ï¼Œäº†è§£ PDã€MRã€QPã€CQã€WRã€SGEã€WC ç­‰åŸºæœ¬æ¦‚å¿µã€‚
    - é˜…è¯» [RDMA Tutorial - Netdev](https://netdevconf.info/0x16/slides/40/RDMA%20Tutorial.pdf)ï¼Œå…¶ä¸­ä»‹ç»äº† `ipv_pd` ç­‰é‡è¦çš„ APIã€‚
    - é˜…è¯» [Introduction to Programming Infiniband RDMA Â· Better Tomorrow with Computer Science](https://insujang.github.io/2020-02-09/introduction-to-programming-infiniband/)ï¼Œè¿™ç¯‡æ–‡ç« é€æ­¥è®²è§£äº†å¦‚ä½•ç¼–å†™ä¸€ä¸ªç®€å•çš„ RDMA ç¨‹åºï¼Œå¹¶ç»™å‡ºäº†è¯¦ç»†çš„ä»£ç ã€‚

!!! note

    ç›¸å…³å¤´æ–‡ä»¶ä¸º `infiniband/verbs.h`ï¼ŒDebian è½¯ä»¶åŒ…ä¸º `libibverbs-dev`ã€‚

ä»£ç è§ [`RDMA_RC_example.c`](./hpn.assets/code/RDMA_RC_example.c)ã€‚

å‡†å¤‡é˜¶æ®µï¼š

- `resource_create()`ï¼šåˆ›å»ºèµ„æºï¼ŒåŒ…æ‹¬ PDã€MRã€QPã€CQ ç­‰ã€‚
- `connect_qp()`ï¼šé€šä¿¡åŒæ–¹äº¤æ¢ä¿¡æ¯ï¼ŒåŒ…æ‹¬ LIDã€QP_NUMã€RKEY ç­‰ï¼Œå°† QP çŠ¶æ€æ›´æ”¹ä¸º INITã€RTRã€RTSã€‚
    - `sock_sync_data()`ï¼šé€šè¿‡ TCP é€šä¿¡äº¤æ¢ä¿¡æ¯ã€‚
    - `modify_qp_to_init()`
    - `post_receive()`ï¼šé¢„ç½®æ¥æ”¶é˜Ÿåˆ—ï¼Œä¹Ÿå¯ä»¥æ”¾åœ¨é€šä¿¡é˜¶æ®µã€‚
    - `modify_qp_to_rtr()`
    - `modify_qp_to_rts()`
    - åŒæ­¥ç‚¹

```mermaid
flowchart TD
 subgraph s1["resource_create()"]
  n27@{ shape: "rounded", label: "ibv_query_port()" }
  n26@{ shape: "hex", label: "ibv_port_attr" }
  n25@{ shape: "hex", label: "ibv_mr" }
  n17@{ shape: "hex", label: "char *" }
  n16@{ shape: "rounded", label: "ibv_get_device_name()" }
  n15@{ shape: "rounded", label: "ibv_get_device_list()" }
  n14@{ shape: "hex", label: "ibv_device" }
 n1@{ shape: "hex", label: "ibv_pd" }
 n2@{ shape: "rounded", label: "ibv_alloc_pd()" }
 n3@{ shape: "hex", label: "ibv_context" }
 n4@{ shape: "hex", label: "buf" }
 n3 --- n2
 n2 --- n1
 n5@{ shape: "rounded", label: "ibv_open_device()" }
 n5 --- n3
 n6@{ shape: "rounded", label: "ibv_create_cq()" }
 n3 --- n6
 n7@{ shape: "hex", label: "mr_flags" }
 n8@{ shape: "rounded", label: "ibv_reg_mr" }
 n4 --- n8
 n7@{ shape: "fr-rect", label: "mr_flags<br/>=IBV_ACCESS_REMOTE_READ|..." } --- n8
 n1 --- n8@{ shape: "rounded", label: "ibv_reg_mr()" }
 n9@{ shape: "hex", label: "ibv_qp_init_attr" }
 n10@{ shape: "hex", label: "ibv_cq" }
 n6 --- n10
 n9@{ shape: "hex", label: "ibv_qp_init_attr" }
 n10 ---|"send_cq, recv_cq"| n9
 n11@{ shape: "fr-rect", label: "qp_type<br/>=IBV_QPT_RC" }
 n11 --- n9
 n12@{ shape: "rounded", label: "ibv_create_qp()" }
 n9 --- n12
 n13@{ shape: "hex", label: "ibv_qp" }
 n12 --- n13
 end
 n15 --- n14@{ shape: "hex", label: "ibv_device **" }
 n14 --- n16
 n16 --- n17
 n14 --- n5
 subgraph s2["connect_qp()"]
  n36@{ shape: "rounded", label: "sock_sync_data()" }
  subgraph s3["cm_con_data_t"]
   n24@{ shape: "hex", label: "buf" }
   n23@{ shape: "hex", label: "lid" }
   n22@{ shape: "hex", label: "qp_num" }
   n20@{ shape: "hex", label: "rkey" }
   n21@{ shape: "hex", label: "gid" }
  end
  n18@{ shape: "hex", label: "ibv_gid" }
  n19@{ shape: "rounded", label: "ibv_query_gid()" }
 end
 n3 --- n19
 n19 --- n18
 n18 --- n21
 n8 --- n25
 n25 --- n20
 n4 --- n24
 n13 --- n22
 n27 --- n26
 n3 --- n27
 n26 --- n23
 n29 --- n30
 n13 --- n30
 n28 --- n29
 subgraph s5["post_receive()"]
  n33@{ shape: "rounded", label: "ibv_post_recv" }
  n32@{ shape: "hex", label: "ibv_recv_wr" }
  n31@{ shape: "hex", label: "ibv_sge" }
 end
 n25 ---|"lkey"| n31
 n4 --- n31
 subgraph s4["modify_qp_to_init, rts()"]
  n28@{ shape: "fr-rect", label: "qp_state<br/>=IBV_QPS_INIT" }
  n30@{ shape: "rounded", label: "ibv_modify_qp()" }
  n29@{ shape: "hex", label: "ibv_qp_attr" }
 end
 n31 --- n32
 n32 --- n33
 subgraph s6["modify_qp_to_rtr()"]
  n34@{ shape: "rounded", label: "Rounded Rectangle" }
  n35@{ shape: "hex", label: "ibv_qp_attr" }
 end
 n22 --- n35
 n23 --- n35
 n35 --- n34@{ shape: "rounded", label: "ibv_modify_qp()" }
 s3 --- n36
```

é€šä¿¡é˜¶æ®µï¼š

- `post_send()`ï¼šåˆ›å»ºå¹¶å‘é€ WRï¼ŒWR çš„ç±»å‹å–å†³äº `opcode`ã€‚
- `poll_completion()`ï¼šè½®è¯¢å¾—åˆ° WCã€‚

```mermaid
flowchart TD
 subgraph s1["post_send()"]
  n12@{ shape: "rounded", label: "ibv_post_send()" }
  n7@{ shape: "fr-rect", label: ".opcode<br/>IBV_WR_SEND<br/>IBV_WR_RDMA_READ<br/>IBV_WR_RDMA_WRITE" }
  n1@{ shape: "hex", label: "ibv_sge" }
  n2@{ shape: "hex", label: "ibv_send_wr" }
 end
 n3@{ shape: "hex", label: "ibv_mr" }
 n3 ---|".lkey"| n1
 n4@{ shape: "hex", label: "buf" }
 n4 --- n1
 n1 --- n2
 subgraph s2["IBV_WR_SEND only"]
  n5@{ shape: "hex", label: ".rkey" }
  n6@{ shape: "hex", label: ".remote_addr" }
 end
 s2 ---|".wr.rdma"| n2
 n7 --- n2
 subgraph s3["poll_completion()"]
  n11@{ shape: "rounded", label: "assert()" }
  n10@{ shape: "rounded", label: "ibv_poll_cq()" }
  n9@{ shape: "hex", label: "ibv_wc" }
 end
 n8@{ shape: "hex", label: "ibv_cq" }
 n9 --- n10
 n8 --- n10
 n10 ---|".status == IBV_WC_SUCCESS"| n11
 n2 --- n12
```

è¯¥ç¨‹åºæ¼”ç¤ºäº†ä¸‹é¢çš„æ“ä½œï¼š

- `resource_create()`ï¼šæœåŠ¡ç«¯æŠŠ `SEND operation` å­—ç¬¦ä¸²æ”¾åœ¨ç¼“å†²åŒº `res->buf` ä¸­ã€‚
- `connect_qp()`ï¼šäº¤æ¢èµ„æºä¿¡æ¯ï¼Œè¿œç«¯ä¿¡æ¯æ”¾å…¥ `res->remote_props`ã€‚äº¤æ¢å†…å®¹åŒ…æ‹¬ `res->buf` çš„åœ°å€ã€‚Client å‘ Server å‘é€ä¸€ä¸ª Receiveã€‚
- `post_send()`ï¼šServer å‘é€ä¸€ä¸ª Sendã€‚è¯¥ WR çš„æ„æˆï¼š
    - `.sg_list->addr` ä¸º `res->buf`ï¼Œå³ Server çš„ç¼“å†²åŒºåœ°å€ã€‚
    - `.wr.rdma.remote_addr` ä¸º `res->remote_props.addr`ï¼Œå³ Client çš„ç¼“å†²åŒºåœ°å€ã€‚
- `poll_completion()`ï¼šClient æ”¶åˆ°å¹¶æ˜¾ç¤ºä¿¡æ¯ `SEND operation`ã€‚
- Server å†å°†ç¼“å†²åŒºå†…å®¹ä¿®æ”¹ä¸º `RDMA read operation`ã€‚
- `post_send()`ï¼šClient å‘é€ä¸€ä¸ª read æ“ä½œï¼Œè¯»å–åˆ° `RDMA read operation`ã€‚å› ä¸ºè¿™æ˜¯å•è¾¹æ“ä½œï¼ŒServer ä¸ä¼šçŸ¥é“ã€‚
- Client å°†ç¼“å†²åŒºå†…å®¹ä¿®æ”¹ä¸º `RDMA write operation`ã€‚
- `post_send()`ï¼šClient å‘é€ä¸€ä¸ª write æ“ä½œï¼Œå†™å…¥åˆ° Server çš„ç¼“å†²åŒºã€‚
- Server æ‰“å°ç¼“å†²åŒºå†…å®¹ï¼Œä¸º `RDMA write operation`ã€‚

#### æ·±å…¥ IB Verbs æŠ€æœ¯è§„èŒƒ

!!! quote

    - [Mellanox Adapters Programmerâ€™s Reference Manual](https://network.nvidia.com/files/doc-2020/ethernet-adapters-programming-manual.pdf)

å‚è€ƒé“¾æ¥ä¸­çš„ç¼–ç¨‹æ‰‹å†Œå°† IB Verbs çš„æ‰€æœ‰ç»†èŠ‚éƒ½è®²è§£å¾—å¾ˆæ¸…æ¥šã€‚

#### RDMA_CM

!!! note

    ç›¸å…³å¤´æ–‡ä»¶ä¸º `rdma/rdma_cma.h`ï¼ŒDebian è½¯ä»¶åŒ…ä¸º `librdmacm-dev`ã€‚

ä»£ç è§ [`mckey.c`](./hpn.assets/code/mckey.c)ã€‚

RDMA_CM ç”¨äºç®¡ç† RDMA è¿æ¥ï¼ŒåŒ…è£…äº†ä½¿ç”¨ socket ç¼–ç¨‹äº¤æ¢ QPã€R_Key ç­‰ä¿¡æ¯çš„è¿‡ç¨‹ï¼Œå‡å°‘ä»£ç é‡ã€‚å®ƒçš„æ¥å£ä¸ Socket ç±»ä¼¼ï¼š

```c
rdma_listen()
rdma_connect()
rdma_accept()
```

ä¸ Socket ç¼–ç¨‹çš„æ¯”è¾ƒï¼š

- æ“ä½œå¼‚æ­¥è¿›è¡Œï¼Œé€šè¿‡ `rdma_event_channel` è¿›è¡Œäº‹ä»¶é€šçŸ¥ã€‚
- `rdma_cm_id`ï¼ˆidentifierï¼‰ä¸ `fd` ç±»ä¼¼ï¼Œç”¨äºæ ‡è¯†è¿æ¥ã€‚
- ä½¿ç”¨ `rdma_bind_addr()` å°† `rdma_cm_id` ä¸ `sockaddr` ç»‘å®šï¼Œç±»ä¼¼ `bind()`ã€‚

æœ¬ä¾‹ä¸ºå¤šæ’­é€šä¿¡ï¼Œéœ€è¦ä½¿ç”¨ `rdma_join_multicast()` å’Œ `rdma_leave_multicast()` è¿›å‡ºå¤šæ’­ç»„ã€‚

```mermaid
flowchart TD
 subgraph s1["run()"]
  subgraph s2["connect_evnets() [LOOP]"]
   subgraph s5["join_handler()"]
    n14@{ shape: "rounded", label: "ibv_create_ah()" }
    n15@{ shape: "rounded", label: "inet_ntop()" }
   end
   subgraph s4["addr_handler()"]
    n12@{ shape: "rounded", label: "rdma_join_multicast()" }
    n13@{ shape: "rounded", label: "ibv_post_recv()" }
   end
   subgraph s3["cma_handler()"]
   end
   n9@{ shape: "rounded", label: "rdma_ack_cm_evnet()" }
   n11@{ shape: "rounded", label: "rdma_get_cm_event()" }
   n10@{ shape: "hex", label: "rdma_cm_event" }
  end
  n8@{ shape: "rounded", label: "rdma_bind_addr()" }
  n7@{ shape: "hex", label: "char *" }
  n6@{ shape: "rounded", label: "getaddrinfo()" }
  n5@{ shape: "hex", label: "sockaddr" }
  n2@{ shape: "rounded", label: "rdma_create_id()" }
  n1@{ shape: "hex", label: "rdma_cm_id" }
 end
 n3@{ shape: "hex", label: "rdma_event_channel" }
 n4@{ shape: "rounded", label: "rdma_create_event_channel" }
 n4@{ shape: "rounded", label: "rdma_create_event_channel()" } --- n3
 n3 --- n2
 n2 --- n1
 n6 --- n5
 n7 --- n6
 n5 ---|"src_addr"| n8
 n1 --- n8
 n11 --- n10
 n10 --- n9
 s3 --- s4
 s3 --- s5
 n10 --- s3
 n3 --- n11
 n1 --- s3
 n16@{ shape: "rounded", label: "rdma_leave_multicast()" }
 n1 --- n16
 n5 ---|"dst_addr"| n12
 n12 --- n16
```

#### RDMA Verbs

!!! note

    ç›¸å…³å¤´æ–‡ä»¶ä¸º `rdma/rdma_verbs.h`ï¼ŒDebian è½¯ä»¶åŒ…ä¸º `librdmacm-dev`ï¼Œç›¸å…³ API ä¸€èˆ¬ä»¥ `rdma_` å¼€å¤´ã€‚

[`srq.c`](./hpn.assets/code/srq.c) æ˜¯ä¸€ä¸ªä½¿ç”¨ SRQï¼ˆShared Receive Queueï¼‰çš„ä¾‹å­ã€‚

#### `mlx5dv` ä¸ DevX

!!! quote

    - [Mellanox/devx](https://github.com/Mellanox/devx)
    - [mlx5dv(7) â€” libibverbs-dev â€” Debian testing â€” Debian Manpages](https://manpages.debian.org/testing/libibverbs-dev/mlx5dv.7.en.html)
    - [rdma-core/providers/mlx5/man at master Â· linux-rdma/rdma-core](https://github.com/linux-rdma/rdma-core/tree/master/providers/mlx5/man)

!!! note

    ç›¸å…³å¤´æ–‡ä»¶ä¸º `infiniband/mlx5dv.h`ï¼Œç›¸å…³çš„ API ä¸€èˆ¬ä»¥ `mlx5dv_` å¼€å¤´ã€‚

`mlx5dv`ï¼ˆDirect Verbsï¼‰API æ”¯æŒä»ç”¨æˆ·ç©ºé—´ç›´æ¥è®¿é—® mlx5 é©±åŠ¨è®¾å¤‡çš„èµ„æºï¼Œç»•è¿‡ `libibverbs` çš„æ•°æ®é€šè·¯ï¼Œç›´æ¥æš´éœ²ä½çº§åˆ«çš„æ•°æ®é€šè·¯ã€‚

!!! tip "å…¼å®¹æ€§"

    ä» Connect-IB å¼€å§‹çš„æ‰€æœ‰ Mellanox ç½‘å¡è®¾å¤‡ï¼ˆåŒ…æ‹¬ Connect-IBã€ConnectX-4ã€ConnectX-4Lxã€ConnectX-5 ç­‰ï¼‰éƒ½å®ç°äº† mlx5 APIã€‚

DevX API ç–‘ä¼¼æ˜¯ Mellanox å¼€å‘çš„ `mlx5dv` çš„å‰èº«ï¼Œå…¶ä»“åº“ä¸Šæ¬¡æ›´æ–°æ—¶é—´ä¸º 2018 å¹´ï¼Œå½“å¹´ `mlx5dv` ä¹Ÿå¹¶å…¥äº† `rdma-core`ã€‚ç°åœ¨ DevX æˆä¸ºäº† `mlx5dv` çš„ä¸€éƒ¨åˆ†ã€‚

è¿™éƒ¨åˆ†çš„æ–‡æ¡£å°‘å¾—å¯æ€œã€‚ç›®å‰ä»…æœ‰çš„æ–‡æ¡£æ¥è‡ª `rdma-core/providers/mlx5/man` çš„ mlx5 Programmer's Manualã€‚æˆ‘ä»¬å…ˆå¯¹ DevX API çš„å„ä¸ªéƒ¨åˆ†å»ºç«‹å¤§æ¦‚çš„å°è±¡ï¼š

- DevXï¼ˆè§ `mlx5dv_devx_obj_create`ï¼‰ï¼šç›®æ ‡æ˜¯ä½¿ç”¨æˆ·ç©ºé—´é©±åŠ¨ç¨‹åºå°½å¯èƒ½ç‹¬ç«‹äºå†…æ ¸ã€‚å½“è®¾å¤‡æä¾›æ–°çš„åŠŸèƒ½å’Œå‘½ä»¤æ—¶ï¼Œä¸éœ€è¦å†…æ ¸æ›´æ”¹å°±èƒ½ä½¿ç”¨ã€‚
    - DEVX å¯¹è±¡ä»£è¡¨åº•å±‚çš„å›ºä»¶å¯¹è±¡ã€‚
    - åˆ›å»º DEVX å¯¹è±¡åï¼Œå¯ä»¥é€šè¿‡ `mlx5dv_devx` API è¿›è¡ŒæŸ¥è¯¢ã€ä¿®æ”¹æˆ–é”€æ¯ã€‚

    !!! tip "è¿™ä¸€éƒ¨åˆ†çš„æ•°æ®ç»“æ„éƒ½æ˜¯å›ºä»¶ç›¸å…³çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œç¼–ç¨‹æ—¶é‡‡ç”¨å¤§é‡å®å®šä¹‰å’Œä½æ“ä½œã€‚éœ€è¦ä»”ç»†æŸ¥çœ‹å…·ä½“çš„è®¾å¤‡æ–‡æ¡£ã€‚"

- Direct Ruleï¼ˆè§ `mlx5dv_dr_flow`ï¼‰ï¼šè®©åº”ç”¨ç¨‹åºç›´æ¥æ§åˆ¶è®¾å¤‡çš„æ‰€æœ‰åŒ…è½¬å‘ï¼ˆpacket steeringï¼‰åŠŸèƒ½ï¼Œå®šä¹‰å¤æ‚çš„æµè¡¨è§„åˆ™ï¼ŒåŒ…æ‹¬è®¡æ•°ã€å°è£…ã€è§£å°è£…ç­‰ã€‚

##### DMA ç¤ºä¾‹

ä½¿ç”¨ `mlx5dv` API æ‰§è¡Œ DMA æ‹·è´ï¼š

- Hostï¼š
    - ç”¨ IB Verb åˆ›å»ºè®¾å¤‡ä¸Šä¸‹æ–‡ã€PD
    - ä½¿ç”¨ `mlx5dv_devx_umem_reg()` æ³¨å†Œç”¨æˆ· DMA å†…å­˜ï¼Œè·å¾—ä¸€ä¸ª `struct mlx5dv_devx_umem`ã€‚
    - ä½¿ç”¨ `MLX5_CMD_OP_CREATE_MKEY` è°ƒç”¨ `mlx5dv_devx_obj_create()` è·å¾— MKEYã€‚
    - ä½¿ç”¨ `mlx5dv_devx_general_cmd()` æ‰§è¡Œ `MLX5_CMD_OP_ALLOW_OTHER_VHCA_ACCESS`ï¼Œå…è®¸å…¶ä»– VHCA è®¿é—®å†…å­˜ã€‚
- Deviceï¼š
    - ç”¨ IB Verb åˆ›å»ºè®¾å¤‡ä¸Šä¸‹æ–‡ã€PD å’Œ MRã€‚
    - ä» Host è·å–ç›¸å…³æ•°æ®
    - ä½¿ç”¨ `MLX5_CMD_OP_CREATE_GENERAL_OBJECT` å’Œ `MLX5_GENERAL_OBJ_TYPE_MKEY` è°ƒç”¨`mlx5dv_devx_obj_create()` åˆ›å»º MR åˆ«åã€‚

### Linux RDMA è¿ç»´

```bash
ib_read_bw
show_gids
```

## æ–‡çŒ®é˜…è¯»

### EuroSysâ€™20 [StRoM: Smart Remote Memory](https://doi.org/10.1145/3342195.3387519)

åŸºäº FPGA çš„ SmartNICã€‚æ‰©å±• IB Verbsï¼Œå°† RPC æ“ä½œ Offload åˆ°è¿œç«¯ SmartNIC ä¸Šæ‰§è¡Œã€‚å¥½å¤„æ˜¯èƒ½å¤Ÿå°†å¤šæ¬¡ RTT çš„æ“ä½œåˆå¹¶ä¸ºä¸€æ¬¡ RTTï¼Œåˆ°é è¿‘æ•°æ®çš„åœ°æ–¹æ‰§è¡Œã€‚

ç³»ç»Ÿç”±ä¸‰ä¸ªéƒ¨åˆ†æ„æˆï¼š

- RoCE ç½‘ç»œæ ˆ
- StRoM å¯ç¼–ç¨‹ Kernel
- DMA å¼•æ“

è®ºæ–‡ä¸­çš„å…¸å‹åº”ç”¨åœºæ™¯ï¼š

- KV å­˜å‚¨ï¼šåœ¨ NIC ä¸Šé€šè¿‡ DMA è¯»å“ˆå¸Œè¡¨å’Œè·å–æ•°æ®ã€‚

ä¸€äº›çŸ¥è¯†ç‚¹ï¼š

- RDMA æ“ä½œä½¿ç”¨**è™šæ‹Ÿå†…å­˜åœ°å€**ï¼Œä½†æ˜¯ PCIe è®¿é—®ä¸»å­˜ä½¿ç”¨**ç‰©ç†å†…å­˜åœ°å€**ã€‚å› æ­¤ SmartNIC ä¸Šéœ€è¦ä¸€ä¸ª TLBã€‚



Resources on BlueField 2 Smart NICs: https://gist.github.com/aagontuk/cf01763c8ee26383afe10f51c9cd2984

- äº¤æ¢èŠ¯ç‰‡ BlueFieldï¼šç”¨äº DPU äº§å“çº¿ï¼Œç®€å•æ¥è¯´å°±æ˜¯ç½‘å¡ä¸Šæœ‰ç‹¬ç«‹çš„ CPUï¼Œå¯ä»¥å¤„ç†ç½‘ç»œæµé‡ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯ BlueField-2 DPU çš„æ¶æ„å›¾ï¼š

<figure markdown="span">
    ![rdma_bf2_arch](hpn.assets/rdma_bf2_arch.webp){ width=50% align=center}
    <figcaption>
    BlueField-2 DPU æ¶æ„
    <br /><small>
    [Nvidia Bluefield DPU Architecture - DELL](https://infohub.delltechnologies.com/en-us/l/dpus-in-the-new-vsphere-8-0-and-16th-generation-dell-poweredge-servers/nvidia-bluefield-dpu-architecture/)
</small></figcaption></figure>

## RoCE åŸç†

??? quote

    - [ç«¯åˆ°ç«¯ RoCE æ¦‚å¿µåŸç†ä¸éƒ¨ç½²è°ƒä¼˜](http://www.bj-joynet.com/static/upload/file/20221025/1666684563267006.pdf)ï¼šå¤§éƒ¨åˆ†æ˜¯å®é™…æ“ä½œï¼Œæ²¡æœ‰æ¸…æ™°çš„ç†è®ºè®²è§£ã€‚

RoCE åè®®å­˜åœ¨ RoCEv1 å’Œ RoCEv2 ä¸¤ä¸ªç‰ˆæœ¬ï¼Œå–å†³äºæ‰€ä½¿ç”¨çš„ç½‘ç»œé€‚é…å™¨ã€‚

- RoCE v1ï¼šåŸºäºä»¥å¤ªç½‘**é“¾è·¯å±‚**å®ç°çš„ RDMA åè®® (äº¤æ¢æœºéœ€è¦æ”¯æŒ PFC ç­‰æµæ§æŠ€æœ¯ï¼Œåœ¨ç‰©ç†å±‚ä¿è¯å¯é ä¼ è¾“ï¼‰ã€‚
- RoCE v2ï¼šå°è£…ä¸º **UDPï¼ˆç«¯å£ 4791ï¼‰ + IPv4/IPv6**ï¼Œä»è€Œå®ç° L3 è·¯ç”±åŠŸèƒ½ã€‚å¯ä»¥è·¨ VLANã€è¿›è¡Œ IP ç»„æ’­äº†ã€‚RoCEv2 å¯ä»¥å·¥ä½œåœ¨ Lossless å’Œ Lossy æ¨¡å¼ä¸‹ã€‚
    - Losslessï¼šé€‚ç”¨äºæ•°æ®ä¸­å¿ƒç½‘ç»œï¼Œè¦æ±‚äº¤æ¢æœºæ”¯æŒ DCBï¼ˆData Center Bridgingï¼‰æŠ€æœ¯ã€‚

### RoCE åŒ…æ ¼å¼

<figure markdown="span">
    ![rdma_packet_infiniband](hpn.assets/roce_packet_infiniband.webp){ width=80% align=center}
    ![roce_packet_version](hpn.assets/roce_packet_version.webp){ width=80% align=center}
    <figcaption>
    RoCE åŒ…æ ¼å¼
    <br /><small>
    [RoCE æŒ‡å— - FS](https://community.fs.com/hk/article/roce-rdma-over-converged-ethernet.html)
</small></figcaption></figure>

## DPDK

## é—®é¢˜è®°å½•

### ç¼–è¯‘ç›¸å…³

- ç¼–è¯‘ DPDK æ—¶

    ```text
    Generating drivers/rte_common_ionic.pmd.c with a custom command
    FAILED: drivers/rte_common_ionic.pmd.c
    ...
    Exception: elftools module not found
    ```

    è§£å†³æ–¹æ³•ï¼š`pip` å®‰è£… `pyelftools` æ¨¡å—

## å…¶ä»–ç›¸å…³çŸ¥è¯†

- DMA æœºåˆ¶ï¼šåŒ…æ‹¬ IOVAã€VFIO ç­‰ã€‚
- Linux å†…å­˜ç®¡ç†æœºåˆ¶ï¼šåŒ…æ‹¬ Hugepageã€NUMA ç­‰ã€‚
- Linux èµ„æºåˆ†é…æœºåˆ¶ï¼šåŒ…æ‹¬ cgroup ç­‰ã€‚
- åŸºç¡€çº¿ç¨‹åº“ pthreadã€‚

- Non-Uniform Memory Access (NUMA)ï¼šéä¸€è‡´æ€§å†…å­˜è®¿é—®ã€‚
    - ä¸ UMA ç›¸æ¯”çš„ä¼˜åŠ£ï¼šå†…å­˜å¸¦å®½å¢å¤§ï¼Œéœ€è¦ç¼–ç¨‹è€…è€ƒè™‘å±€éƒ¨æ€§
    - æ¯å—å†…å­˜æœ‰
        - homeï¼šç‰©ç†ä¸ŠæŒæœ‰è¯¥åœ°å€ç©ºé—´çš„å¤„ç†å™¨
        - ownerï¼šæŒæœ‰è¯¥å—å†…å­˜å€¼ï¼ˆå†™äº†è¯¥å—å†…å­˜ï¼‰çš„å¤„ç†å™¨
    - Linux NUMAï¼š<https://docs.kernel.org/mm/numa.html>
        - Cache Coherent NUMA
        - ç¡¬ä»¶èµ„æºåˆ’åˆ†ä¸º node
            - éšè—äº†ä¸€äº›ç»†èŠ‚ï¼Œä¸èƒ½é¢„æœŸåŒä¸ª node ä¸Šçš„è®¿å­˜æ•ˆç‡ç›¸åŒ
            - æ¯ä¸ª node æœ‰è‡ªå·±çš„å†…å­˜ç®¡ç†ç³»ç»Ÿ
            - Linux ä¼šå°½å¯èƒ½ä¸ºä»»åŠ¡åˆ†é… node-local å†…å­˜
            - åœ¨è¶³å¤Ÿä¸å¹³è¡¡çš„æ¡ä»¶ä¸‹ï¼Œscheduler ä¼šå°†ä»»åŠ¡è¿ç§»åˆ°å…¶ä»– nodeï¼Œé€ æˆè®¿å­˜æ•ˆç‡ä¸‹é™
        - Memory Policy
    - Linux å®è·µ
        - `numactl`
        - `lstopo`

- Hugepage
    - å—é™äº TLB å¤§å°ï¼ŒHugepage ä¼šå‡å°‘ TLB miss
    - åœºæ™¯ï¼šéšæœºè®¿å­˜ã€å¤§å‹æ•°æ®ç»“æ„
    - <https://www.evanjones.ca/hugepages-are-a-good-idea.html>
    - <https://rigtorp.se/hugepages/>
