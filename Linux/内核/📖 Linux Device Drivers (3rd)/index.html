
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Bowling 的笔记本">
      
      
        <meta name="author" content="Bowling">
      
      
        <link rel="canonical" href="https://note.bowling233.top/Linux/%E5%86%85%E6%A0%B8/%F0%9F%93%96%20Linux%20Device%20Drivers%20%283rd%29/">
      
      
        <link rel="prev" href="../../%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/">
      
      
        <link rel="next" href="../%F0%9F%93%96%20Linux%20Kernel%20Development%20%283rd%29/">
      
      
      <link rel="icon" href="../../../assets/bowling.svg">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>📖 Linux Device Drivers (3rd) - Bowling's TechStack</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.bcfcd587.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="../../../stylesheets/flink.css">
    
      <link rel="stylesheet" href="../../../stylesheets/neoteroi-mkdocs.css">
    
      <link rel="stylesheet" href="../../../stylesheets/custom.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-lite-webfont@1.1.0/style.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-tc-webfont@1.0.0/style.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#linux-device-drivers-3rd" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Bowling&#39;s TechStack" class="md-header__button md-logo" aria-label="Bowling's TechStack" data-md-component="logo">
      
  <img src="../../../assets/bowling.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Bowling's TechStack
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              📖 Linux Device Drivers (3rd)
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/bowling233/TechStack" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    TechStack
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  首页

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../links/" class="md-tabs__link">
        
  
    
  
  友链

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../" class="md-tabs__link">
          
  
    
  
  Linux

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E5%85%B6%E4%BB%96/%E6%94%B6%E8%97%8F%E5%A4%B9/" class="md-tabs__link">
          
  
    
  
  其他

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E5%BA%94%E7%94%A8%E9%A2%86%E5%9F%9F/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/LLM%20Infra/" class="md-tabs__link">
          
  
    
  
  应用领域

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E7%A7%91%E7%A0%94/%E8%8D%89%E7%A8%BF/" class="md-tabs__link">
          
  
    
  
  科研

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E7%AE%97%E6%B3%95/%F0%9F%8F%AB%20%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%9F%BA%E7%A1%80/" class="md-tabs__link">
          
  
    
  
  算法

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E7%B3%BB%E7%BB%9F%E5%92%8C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/" class="md-tabs__link">
          
  
    
  
  系统和体系结构

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E7%BD%91%E7%BB%9C/%F0%9F%93%92%20%E4%BB%A3%E7%90%86%E4%B8%8E%E8%99%9A%E6%8B%9F%E4%B8%93%E7%94%A8%E7%BD%91/" class="md-tabs__link">
          
  
    
  
  网络

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E8%8D%89%E7%A8%BF/" class="md-tabs__link">
          
  
    
  
  草稿

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E8%AF%AD%E8%A8%80/go/" class="md-tabs__link">
          
  
    
  
  语言

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../%E9%AB%98%E6%80%A7%E8%83%BD/%E5%B9%B6%E8%A1%8C%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/C%2B%2B%20%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" class="md-tabs__link">
          
  
    
  
  高性能

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Bowling&#39;s TechStack" class="md-nav__button md-logo" aria-label="Bowling's TechStack" data-md-component="logo">
      
  <img src="../../../assets/bowling.svg" alt="logo">

    </a>
    Bowling's TechStack
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/bowling233/TechStack" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    TechStack
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    首页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../links/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    友链
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Linux
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Linux
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%8F%91%E8%A1%8C%E7%89%88%E4%B8%8E%E5%8C%85%E7%AE%A1%E7%90%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    发行版与包管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    启动过程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" checked>
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    内核
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            内核
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    📖 Linux Device Drivers (3rd)
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    📖 Linux Device Drivers (3rd)
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      第一章：设备驱动介绍
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      第二章：构建和运行模块
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第二章：构建和运行模块">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      配置测试系统
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      样例模块
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      内核模块与应用的对比
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      编译和加载
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      内核符号表
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      准备工作
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      初始化和关闭
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      模块参数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      在用户空间内操作
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      第三章：字符设备
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第三章：字符设备">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scull" class="md-nav__link">
    <span class="md-ellipsis">
      scull 的设计
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      主要和次要设备号
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      一些重要的数据结构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      注册字符设备
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      打开和释放
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scull_1" class="md-nav__link">
    <span class="md-ellipsis">
      scull 的内存使用
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      读和写
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      使用新设备
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      第四章：调试技术
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第四章：调试技术">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      内核调试支持
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      通过打印调试
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      通过查询调试
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      通过观测调试
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      调试系统错误
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      调试器和相关工具
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      第五章：并发和竞争条件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第五章：并发和竞争条件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      并发及其管理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#semaphoremutex" class="md-nav__link">
    <span class="md-ellipsis">
      旗语（Semaphore）和锁（Mutex）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      锁的常见错误
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      锁的替代品
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      第六章：高级字符驱动操作
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第六章：高级字符驱动操作">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ioctl" class="md-nav__link">
    <span class="md-ellipsis">
      ioctl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io" class="md-nav__link">
    <span class="md-ellipsis">
      阻塞 I/O
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      第七章：时间、延迟与延后工作
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第七章：时间、延迟与延后工作">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      测量时间
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      延迟执行
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      第八章：分配内存
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第八章：分配内存">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kmalloc" class="md-nav__link">
    <span class="md-ellipsis">
      kmalloc 的细节
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lookaside" class="md-nav__link">
    <span class="md-ellipsis">
      Lookaside 缓存
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      第九章：与硬件沟通
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第九章：与硬件沟通">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#io-io" class="md-nav__link">
    <span class="md-ellipsis">
      I/O 端口和 I/O 内存
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io_1" class="md-nav__link">
    <span class="md-ellipsis">
      使用 I/O 端口
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io_2" class="md-nav__link">
    <span class="md-ellipsis">
      一个 I/O 端口例子
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-io-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Using I/O Memory
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      第十章：中断处理
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      第十一章：内核中的数据类型
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pci" class="md-nav__link">
    <span class="md-ellipsis">
      第十二章：PCI 驱动
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usb" class="md-nav__link">
    <span class="md-ellipsis">
      第十三章：USB 驱动
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      第十四章：Linux 设备模型
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第十四章：Linux 设备模型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kobject-kset" class="md-nav__link">
    <span class="md-ellipsis">
      Kobject 和 Kset
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dma" class="md-nav__link">
    <span class="md-ellipsis">
      第十五章：内存映射与 DMA
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第十五章：内存映射与 DMA">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#linux_1" class="md-nav__link">
    <span class="md-ellipsis">
      Linux 内存管理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mmap" class="md-nav__link">
    <span class="md-ellipsis">
      mmap() 设备操作
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io_3" class="md-nav__link">
    <span class="md-ellipsis">
      执行直接 I/O
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dma_1" class="md-nav__link">
    <span class="md-ellipsis">
      DMA
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DMA">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dma_2" class="md-nav__link">
    <span class="md-ellipsis">
      分配 DMA 缓冲区
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dma_3" class="md-nav__link">
    <span class="md-ellipsis">
      通用 DMA 层
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      第十七章：网络驱动
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第十七章：网络驱动">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#snull" class="md-nav__link">
    <span class="md-ellipsis">
      snull 的设计
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      连接到内核
    </span>
  </a>
  
    <nav class="md-nav" aria-label="连接到内核">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      设备注册
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      设备初始化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    <span class="md-ellipsis">
      模块卸载
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#net_device" class="md-nav__link">
    <span class="md-ellipsis">
      net_device 结构详解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="net_device 结构详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    <span class="md-ellipsis">
      设备方法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    <span class="md-ellipsis">
      辅助字段
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    <span class="md-ellipsis">
      打开与关闭
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    <span class="md-ellipsis">
      包传输
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    <span class="md-ellipsis">
      更改链路状态
    </span>
  </a>
  
    <nav class="md-nav" aria-label="更改链路状态">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rtnl" class="md-nav__link">
    <span class="md-ellipsis">
      补充内容：RTNL
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../%F0%9F%93%96%20Linux%20Kernel%20Development%20%283rd%29/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📖 Linux Kernel Development (3rd)
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    文件系统
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3_5" id="__nav_3_5_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            文件系统
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/%F0%9F%93%92%20%E5%86%85%E6%A0%B8%E6%BA%90%E7%A0%81%EF%BC%9ANFS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 内核源码：NFS
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="">
            
  
  <span class="md-ellipsis">
    源码笔记
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            源码笔记
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/bonding/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    drivers/net/bonding
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../%E6%BA%90%E7%A0%81%E7%AC%94%E8%AE%B0/systemd-networkd/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    systemd-networkd
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    其他
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            其他
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B6%E4%BB%96/%E6%94%B6%E8%97%8F%E5%A4%B9/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    收藏夹
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B6%E4%BB%96/%E8%87%AA%E5%8A%A8%E5%8C%96/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    自动化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B6%E4%BB%96/%F0%9F%93%92%20%E5%BF%AB%E6%8D%B7%E9%94%AE/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 快捷键
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B6%E4%BB%96/%F0%9F%93%92%20%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%BD%BF%E7%94%A8%E7%BB%8F%E9%AA%8C%E5%92%8C%E6%8A%80%E5%B7%A7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 操作系统使用经验和技巧
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B6%E4%BB%96/%F0%9F%93%92%20%E8%BD%AF%E4%BB%B6%E4%BD%BF%E7%94%A8%E7%BB%8F%E9%AA%8C%E5%92%8C%E6%8A%80%E5%B7%A7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 软件使用经验和技巧
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B6%E4%BB%96/%F0%9F%93%92%20%E9%9D%A2%E7%BB%8F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 面经
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B6%E4%BB%96/%F0%9F%93%96%20Vim%20%E5%AE%9E%E7%94%A8%E6%8A%80%E5%B7%A7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📖 Vim 实用技巧
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B6%E4%BB%96/%F0%9F%93%96%20%E4%BA%BA%E6%9C%88%E7%A5%9E%E8%AF%9D/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📖 人月神话
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B6%E4%BB%96/%F0%9F%94%97%20%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B1%BB%E7%A7%91%E6%99%AE%E8%A7%86%E9%A2%91/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    🔗 计算机类科普视频
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_10" >
        
          
          <label class="md-nav__link" for="__nav_4_10" id="__nav_4_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    生活
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_10">
            <span class="md-nav__icon md-icon"></span>
            生活
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B6%E4%BB%96/%E7%94%9F%E6%B4%BB/%E4%B8%AA%E4%BA%BA%E5%8F%91%E5%B1%95/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    个人发展
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B6%E4%BB%96/%E7%94%9F%E6%B4%BB/%E6%81%8B%E7%88%B1%E3%80%81%E5%A9%9A%E5%A7%BB%E4%B8%8E%E5%AE%B6%E5%BA%AD/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    恋爱、婚姻与家庭
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B6%E4%BB%96/%E7%94%9F%E6%B4%BB/%E6%9D%82%E4%BA%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    杂事
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B6%E4%BB%96/%E7%94%9F%E6%B4%BB/%E7%A4%BE%E4%BC%9A/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    社会
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B6%E4%BB%96/%E7%94%9F%E6%B4%BB/%F0%9F%93%96%20%E4%BA%B2%E5%AF%86%E5%85%B3%E7%B3%BB%EF%BC%88%E7%AC%AC%208%20%E7%89%88%EF%BC%89/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📖 亲密关系（第 8 版）
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B6%E4%BB%96/%E7%94%9F%E6%B4%BB/%F0%9F%93%96%20%E4%BA%B2%E5%AF%86%E5%85%B3%E7%B3%BB%EF%BC%9A%E9%80%9A%E5%BE%80%E7%81%B5%E9%AD%82%E7%9A%84%E6%A1%A5%E6%A2%81/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📖 亲密关系：通往灵魂的桥梁
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B6%E4%BB%96/%E7%94%9F%E6%B4%BB/%F0%9F%93%96%20%E5%88%BB%E6%84%8F%E7%BB%83%E4%B9%A0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📖 刻意练习
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B6%E4%BB%96/%E7%94%9F%E6%B4%BB/%F0%9F%93%96%20%E5%8E%9F%E7%94%9F%E5%AE%B6%E5%BA%AD%C2%B7%E5%A9%9A%E6%81%8B%E7%89%88/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📖 原生家庭·婚恋版
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_11" >
        
          
          <label class="md-nav__link" for="__nav_4_11" id="__nav_4_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    课程笔记
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_11">
            <span class="md-nav__icon md-icon"></span>
            课程笔记
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%85%B6%E4%BB%96/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/%F0%9F%8F%AB%20%E9%A9%AC%E5%85%8B%E6%80%9D%E4%B8%BB%E4%B9%89%E5%8E%9F%E7%90%86%EF%BC%88H%EF%BC%89/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    🏫 马克思主义原理（H）
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    应用领域
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            应用领域
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_1" >
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    人工智能
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            人工智能
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BA%94%E7%94%A8%E9%A2%86%E5%9F%9F/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/LLM%20Infra/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LLM Infra
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BA%94%E7%94%A8%E9%A2%86%E5%9F%9F/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/%E4%B8%AA%E4%BA%BA%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 人工智能
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BA%94%E7%94%A8%E9%A2%86%E5%9F%9F/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/%F0%9F%93%96%20Dive%20into%20Deep%20Learning/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📖 Dive into Deep Learning
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BA%94%E7%94%A8%E9%A2%86%E5%9F%9F/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/%F0%9F%93%96%20PyTorch%20%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E5%AE%9E%E6%88%98/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📖 PyTorch 深度学习实战
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BA%94%E7%94%A8%E9%A2%86%E5%9F%9F/%E4%BA%BA%E5%B7%A5%E6%99%BA%E8%83%BD/%F0%9F%93%96%20%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📖 深度学习
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../%E5%BA%94%E7%94%A8%E9%A2%86%E5%9F%9F/%E6%95%B0%E6%8D%AE%E5%BA%93/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    数据库
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            数据库
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BA%94%E7%94%A8%E9%A2%86%E5%9F%9F/%E6%95%B0%E6%8D%AE%E5%BA%93/%F0%9F%93%92%20ClickHouse/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ClickHouse
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BA%94%E7%94%A8%E9%A2%86%E5%9F%9F/%E6%95%B0%E6%8D%AE%E5%BA%93/%F0%9F%93%92%20ElasticSearch/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 ElasticSearch
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BA%94%E7%94%A8%E9%A2%86%E5%9F%9F/%E6%95%B0%E6%8D%AE%E5%BA%93/%F0%9F%93%92%20%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%96%E7%A8%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 数据库编程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BA%94%E7%94%A8%E9%A2%86%E5%9F%9F/%E6%95%B0%E6%8D%AE%E5%BA%93/%F0%9F%93%92%20%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%90%E7%BB%B4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 数据库运维
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E5%BA%94%E7%94%A8%E9%A2%86%E5%9F%9F/%E6%95%B0%E6%8D%AE%E5%BA%93/%F0%9F%93%96%20%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F%E6%A6%82%E5%BF%B5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📖 数据库系统概念
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    科研
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            科研
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%A7%91%E7%A0%94/%E8%8D%89%E7%A8%BF/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    草稿
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%A7%91%E7%A0%94/%F0%9F%93%92%20%E7%A7%91%E7%A0%94%E5%86%99%E4%BD%9C/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 科研写作
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%A7%91%E7%A0%94/%F0%9F%93%92%20%E9%AB%98%E6%80%A7%E8%83%BD%E7%BD%91%E7%BB%9C/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 高性能网络
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    算法
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            算法
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%AE%97%E6%B3%95/%F0%9F%8F%AB%20%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%9F%BA%E7%A1%80/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    🏫 数据结构基础
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../%E7%B3%BB%E7%BB%9F%E5%92%8C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    系统和体系结构
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            系统和体系结构
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%B3%BB%E7%BB%9F%E5%92%8C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/ISA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ISA
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%B3%BB%E7%BB%9F%E5%92%8C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/%E6%95%B0%E5%AD%97%E7%94%B5%E8%B7%AF/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    数字电路
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%B3%BB%E7%BB%9F%E5%92%8C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/%F0%9F%93%92%20%E5%AE%B9%E5%99%A8%E5%92%8C%E8%99%9A%E6%8B%9F%E5%8C%96%E6%8A%80%E6%9C%AF/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 容器和虚拟化技术
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%B3%BB%E7%BB%9F%E5%92%8C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/%F0%9F%93%96%20%E6%80%BB%E7%BA%BF/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📖 总线
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%B3%BB%E7%BB%9F%E5%92%8C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/%F0%9F%93%96%20%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📖 深入理解计算机系统
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    网络
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            网络
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BD%91%E7%BB%9C/%F0%9F%93%92%20%E4%BB%A3%E7%90%86%E4%B8%8E%E8%99%9A%E6%8B%9F%E4%B8%93%E7%94%A8%E7%BD%91/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 代理与虚拟专用网
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BD%91%E7%BB%9C/%F0%9F%93%92%20%E7%89%A9%E7%90%86%E5%92%8C%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 物理和数据链路层
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BD%91%E7%BB%9C/%F0%9F%93%92%20%E7%BD%91%E7%BB%9C%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 网络笔记
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BD%91%E7%BB%9C/%F0%9F%93%96%20Head%20First%20HTML/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📖 Head First HTML
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BD%91%E7%BB%9C/%F0%9F%93%96%20%E5%9B%BE%E8%A7%A3%20HTTP/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📖 图解 HTTP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E7%BD%91%E7%BB%9C/%F0%9F%93%96%20%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%EF%BC%9A%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B%E6%96%B9%E6%B3%95/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📖 计算机网络：自顶向下方法
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../%E8%8D%89%E7%A8%BF/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    草稿
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_10" id="__nav_10_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            草稿
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%8D%89%E7%A8%BF/ZFS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ZFS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%8D%89%E7%A8%BF/draft/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    零散笔记
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%8D%89%E7%A8%BF/lvm/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Logical Volume Manager
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%8D%89%E7%A8%BF/%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    分布式文件系统
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%8D%89%E7%A8%BF/%F0%9F%93%92%20%E4%B8%B4%E6%97%B6%E7%AC%94%E8%AE%B0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 临时笔记
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_7" >
        
          
          <label class="md-nav__link" for="__nav_10_7" id="__nav_10_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    HPC
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_7">
            <span class="md-nav__icon md-icon"></span>
            HPC
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%8D%89%E7%A8%BF/HPC/%F0%9F%93%92%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 性能分析
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%8D%89%E7%A8%BF/HPC/%F0%9F%93%92%20%E8%AE%BF%E5%AD%98%E4%BC%98%E5%8C%96/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 访存优化
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_7_3" >
        
          
          <label class="md-nav__link" for="__nav_10_7_3" id="__nav_10_7_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    工具
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_10_7_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_7_3">
            <span class="md-nav__icon md-icon"></span>
            工具
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%8D%89%E7%A8%BF/HPC/%E5%B7%A5%E5%85%B7/spack/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Spack
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%8D%89%E7%A8%BF/HPC/%E5%B7%A5%E5%85%B7/%E7%BC%96%E8%AF%91%E5%A5%97%E4%BB%B6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    编译套件
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10_8" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../%E8%8D%89%E7%A8%BF/RFC/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    RFC
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_10_8" id="__nav_10_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_10_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10_8">
            <span class="md-nav__icon md-icon"></span>
            RFC
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%8D%89%E7%A8%BF/RFC/4506%20XDR/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RFC 4506 - XDR: External Data Representation Standard
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%8D%89%E7%A8%BF/RFC/5531%20RPC/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RFC 5531 - RPC: Remote Procedure Call Protocol Specification Version 2
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%8D%89%E7%A8%BF/RFC/5661%20NFSv4.1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RFC 5661 - Network File System (NFS) Version 4 Minor Version 1 Protocol
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%8D%89%E7%A8%BF/RFC/7530%20NFSv4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    RFC 7530 - Network File System (NFS) Version 4 Protocol
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    语言
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            语言
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AF%AD%E8%A8%80/go/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Go
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AF%AD%E8%A8%80/%F0%9F%93%92%20C%20%E5%92%8C%20C%2B%2B%20%E9%AB%98%E7%BA%A7%E8%AF%9D%E9%A2%98/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 C 和 C++ 高级话题
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AF%AD%E8%A8%80/%F0%9F%93%92%20%E4%BB%A3%E7%A0%81%E9%A3%8E%E6%A0%BC/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 代码风格
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AF%AD%E8%A8%80/%F0%9F%93%92%20%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📒 开发工具
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AF%AD%E8%A8%80/%F0%9F%93%96%20C%2B%2B%20Primer/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📖 C++ Primer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E8%AF%AD%E8%A8%80/%F0%9F%93%96%20%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    📖 编译原理
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_12" >
        
          
          <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    高性能
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            高性能
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_12_1" >
        
          
          <label class="md-nav__link" for="__nav_12_1" id="__nav_12_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    并行程序设计
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_12_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12_1">
            <span class="md-nav__icon md-icon"></span>
            并行程序设计
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../%E9%AB%98%E6%80%A7%E8%83%BD/%E5%B9%B6%E8%A1%8C%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/C%2B%2B%20%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C++ 并发编程
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      第一章：设备驱动介绍
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      第二章：构建和运行模块
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第二章：构建和运行模块">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      配置测试系统
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      样例模块
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      内核模块与应用的对比
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      编译和加载
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      内核符号表
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      准备工作
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      初始化和关闭
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      模块参数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      在用户空间内操作
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      第三章：字符设备
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第三章：字符设备">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#scull" class="md-nav__link">
    <span class="md-ellipsis">
      scull 的设计
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      主要和次要设备号
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      一些重要的数据结构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      注册字符设备
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      打开和释放
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scull_1" class="md-nav__link">
    <span class="md-ellipsis">
      scull 的内存使用
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      读和写
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      使用新设备
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      第四章：调试技术
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第四章：调试技术">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      内核调试支持
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      通过打印调试
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      通过查询调试
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      通过观测调试
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      调试系统错误
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      调试器和相关工具
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      第五章：并发和竞争条件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第五章：并发和竞争条件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      并发及其管理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#semaphoremutex" class="md-nav__link">
    <span class="md-ellipsis">
      旗语（Semaphore）和锁（Mutex）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      锁的常见错误
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      锁的替代品
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      第六章：高级字符驱动操作
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第六章：高级字符驱动操作">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ioctl" class="md-nav__link">
    <span class="md-ellipsis">
      ioctl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io" class="md-nav__link">
    <span class="md-ellipsis">
      阻塞 I/O
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      第七章：时间、延迟与延后工作
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第七章：时间、延迟与延后工作">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      测量时间
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      延迟执行
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      第八章：分配内存
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第八章：分配内存">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kmalloc" class="md-nav__link">
    <span class="md-ellipsis">
      kmalloc 的细节
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#lookaside" class="md-nav__link">
    <span class="md-ellipsis">
      Lookaside 缓存
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      第九章：与硬件沟通
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第九章：与硬件沟通">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#io-io" class="md-nav__link">
    <span class="md-ellipsis">
      I/O 端口和 I/O 内存
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io_1" class="md-nav__link">
    <span class="md-ellipsis">
      使用 I/O 端口
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io_2" class="md-nav__link">
    <span class="md-ellipsis">
      一个 I/O 端口例子
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-io-memory" class="md-nav__link">
    <span class="md-ellipsis">
      Using I/O Memory
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      第十章：中断处理
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      第十一章：内核中的数据类型
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pci" class="md-nav__link">
    <span class="md-ellipsis">
      第十二章：PCI 驱动
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usb" class="md-nav__link">
    <span class="md-ellipsis">
      第十三章：USB 驱动
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      第十四章：Linux 设备模型
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第十四章：Linux 设备模型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#kobject-kset" class="md-nav__link">
    <span class="md-ellipsis">
      Kobject 和 Kset
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dma" class="md-nav__link">
    <span class="md-ellipsis">
      第十五章：内存映射与 DMA
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第十五章：内存映射与 DMA">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#linux_1" class="md-nav__link">
    <span class="md-ellipsis">
      Linux 内存管理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mmap" class="md-nav__link">
    <span class="md-ellipsis">
      mmap() 设备操作
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io_3" class="md-nav__link">
    <span class="md-ellipsis">
      执行直接 I/O
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dma_1" class="md-nav__link">
    <span class="md-ellipsis">
      DMA
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DMA">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dma_2" class="md-nav__link">
    <span class="md-ellipsis">
      分配 DMA 缓冲区
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dma_3" class="md-nav__link">
    <span class="md-ellipsis">
      通用 DMA 层
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      第十七章：网络驱动
    </span>
  </a>
  
    <nav class="md-nav" aria-label="第十七章：网络驱动">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#snull" class="md-nav__link">
    <span class="md-ellipsis">
      snull 的设计
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      连接到内核
    </span>
  </a>
  
    <nav class="md-nav" aria-label="连接到内核">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      设备注册
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      设备初始化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    <span class="md-ellipsis">
      模块卸载
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#net_device" class="md-nav__link">
    <span class="md-ellipsis">
      net_device 结构详解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="net_device 结构详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    <span class="md-ellipsis">
      设备方法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    <span class="md-ellipsis">
      辅助字段
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_45" class="md-nav__link">
    <span class="md-ellipsis">
      打开与关闭
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_46" class="md-nav__link">
    <span class="md-ellipsis">
      包传输
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_47" class="md-nav__link">
    <span class="md-ellipsis">
      更改链路状态
    </span>
  </a>
  
    <nav class="md-nav" aria-label="更改链路状态">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#rtnl" class="md-nav__link">
    <span class="md-ellipsis">
      补充内容：RTNL
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  
  
<nav class="md-tags" >
  
    
    
    
      <a href="../../../#" class="md-tag">读书笔记</a>
    
  
</nav>


  
    <a href="https://github.com/bowling233/TechStack/blob/master/docs/Linux/内核/📖 Linux Device Drivers (3rd).md" title="Edit this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg>
    </a>
  
  


<h1 id="linux-device-drivers-3rd">📖 Linux Device Drivers (3rd)<a class="headerlink" href="#linux-device-drivers-3rd" title="Permanent link">&para;</a></h1>
<div class="admonition abstract">
<p class="admonition-title">Abstract</p>
<ul>
<li><strong>英文版：</strong><a href="https://www.oreilly.com/library/view/linux-device-drivers/0596005903/">Linux Device Drivers, 3rd Edition</a></li>
<li><strong>中文版：</strong><a href="https://book.douban.com/subject/1723151/">Linux 设备驱动程序</a></li>
</ul>
<p>截止到 2025 年，这本书依然是 Linux 驱动开发的最佳入门书籍。和众多经典 Linux 书籍一样，大家对它们的评价是：内核源码处于不断的更新之中，书籍都只能作为起点。学习的最佳方式是从书籍了解相关概念，然后读内核源码和相关文档。</p>
<blockquote>
<p>The LDD book is a reasonable starting point, but as you say it's quite dated in some areas. Kernel APIs tend to change fairly quickly by book standards, which makes it a bit of a tall order.</p>
<p>Generally the best resources tend to be in-tree documentation (where it exists), which stands a higher chance of being up to date, and existing drivers that are doing something similar.</p>
</blockquote>
</div>
<p>这本书基于 Linux 2.6。</p>
<div class="admonition info">
<p class="admonition-title">一些相关的资源</p>
<ul>
<li>源码可以从 <a href="https://resources.oreilly.com/examples/9780596005900.git">examples / Linux Device Drivers 3rd Edition · GitLab</a> 下载。但因其基于 Linux 2.6，基本上跑不起来。</li>
<li><a href="https://github.com/martinezjavier/ldd3">martinezjavier/ldd3: Linux Device Drivers 3 examples updated to work in recent kernels</a> 是目前持续在更新的版本，并且提供了比较好的指导，推荐使用。它基于 5.10。</li>
<li><a href="https://github.com/d0u9/Linux-Device-Driver">d0u9/Linux-Device-Driver: Advanced examples of Linux Device Drivers (LDD3) </a>，基于 5.10，使用 QEMU 进行实验。</li>
</ul>
</div>
<p>本篇笔记使用 <code>martinezjavier/ldd3</code> 进行实验。</p>
<h2 id="_1">第一章：设备驱动介绍<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>三类设备：</p>
<ul>
<li>字符设备：提供字节流<ul>
<li>一般实现 <code>open</code>、<code>close</code>、<code>read</code>、<code>write</code></li>
<li>例子：<code>/dev/console</code></li>
</ul>
</li>
<li>块设备</li>
<li>网络接口</li>
</ul>
<p>杂项：</p>
<ul>
<li>概述了 Linux 系统的整体架构</li>
<li>提及了安全问题：<ul>
<li>驱动编写者应当将尽可能将安全策略移交给更高层次，而不是在驱动中实现。如果对设备的操作可能影响整个系统的安全，就需要做好访问控制，比如只有特权用户才能加载的内核模块。加载模块时，系统调用 <code>init_module</code> 会检查对应进程是否有加载模块的权限。</li>
<li>此外要防范缓冲区溢出等 C 语言容易产生的问题。</li>
<li>在验证之前，不能信任任何从用户空间传来的东西，并且要设计为不论用户给到什么信息都不至于使系统崩溃。从内核拿到的内存一定要初始化，检查内存泄露等。</li>
</ul>
</li>
<li>Linux 可以完全关闭模块功能，此时驱动必须编译进内核。</li>
</ul>
<h2 id="_2">第二章：构建和运行模块<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="_3">配置测试系统<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>首先需要拉取内核源码树并构建，下面记录我的操作过程：</p>
<div class="admonition info">
<p class="admonition-title">构建内核过程</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nb">cd</span><span class="w"> </span>linux
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>yes<span class="w"> </span><span class="s2">&quot;&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>make<span class="w"> </span>oldconfig
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>make<span class="w"> </span>-j
</span></code></pre></div>
<p>在 Debian 系发行版上，依照 <a href="https://www.debian.org/doc/manuals/debian-kernel-handbook/ch-common-tasks.html">Chapter 4. Common kernel-related tasks</a> 操作更加可靠：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>apt-get<span class="w"> </span>install<span class="w"> </span>linux-source<span class="w"> </span>build-essential<span class="w"> </span>fakeroot<span class="w"> </span>devscripts<span class="w"> </span>rsync<span class="w"> </span>git<span class="w"> </span>linux-headers-amd64
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>apt-get<span class="w"> </span>build-dep<span class="w"> </span>linux
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>tar<span class="w"> </span>xaf<span class="w"> </span>/usr/src/linux-source-*.tar.xz
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="nb">cd</span><span class="w"> </span>linux-source-*
</span></code></pre></div>
<p>在 RedHat 系发行版上，参考 <a href="https://docs.fedoraproject.org/en-US/quick-docs/kernel-build-custom/">Building a Custom Kernel :: Fedora Docs</a>：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>dnf<span class="w"> </span>builddep<span class="w"> </span>kernel
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>dnf<span class="w"> </span>download<span class="w"> </span>--source<span class="w"> </span>kernel
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a>rpm2cpio<span class="w"> </span>kernel*.rpm<span class="w"> </span><span class="p">|</span><span class="w"> </span>cpio<span class="w"> </span>-idmv
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="nb">cd</span><span class="w"> </span>linux-source-*
</span></code></pre></div>
<p>如果只需要特定的内核模块，参考 <a href="https://docs.kernel.org/kbuild/modules.html">Building External Modules¶</a></p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nb">cd</span><span class="w"> </span>drivers/net/bonding
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>make<span class="w"> </span>-C<span class="w"> </span>/lib/modules/<span class="sb">`</span>uname<span class="w"> </span>-r<span class="sb">`</span>/build<span class="w"> </span><span class="nv">M</span><span class="o">=</span><span class="nv">$PWD</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>make<span class="w"> </span>-C<span class="w"> </span>/lib/modules/<span class="sb">`</span>uname<span class="w"> </span>-r<span class="sb">`</span>/build<span class="w"> </span><span class="nv">M</span><span class="o">=</span><span class="nv">$PWD</span><span class="w"> </span>modules_install
</span></code></pre></div>
<p>此时模块会被安装到 <code>/lib/modules/$(uname -r)/update/*.ko</code>。直接用其覆盖目标模块即可。</p>
</div>
<h3 id="_4">样例模块<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>略</p>
<h3 id="_5">内核模块与应用的对比<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<ul>
<li>内核模块只与内核链接，因此只能使用内核导出的函数，不能使用标准库函数。</li>
<li>内核模块运行在内核空间，内存映射和地址空间也与普通应用不一样。</li>
<li>当应用执行系统调用或被硬件中断时，进入内核空间。系统调用运行在进程的上下文中，可以访问进程的地址空间。硬件中断是异步的，与特定进程无关。</li>
<li>需要考虑并发场景。并发的来源有：多进程使用驱动、硬件操作过程中发生中断、内核计时器、驱动在多个 CPU 上执行、抢占等。内核与内核模块都需要做到 reentrant，即可以同时运行在多个上下文中。</li>
<li><code>current</code> 指针指向当前进程的 <code>task_struct</code> 结构体。</li>
<li>内核的栈非常小，可以小到一个 4K 页。我们写的函数与内核空间的调用链一起使用这个栈。因此，不应当使用大型局部变量，应当动态分配。</li>
</ul>
<h3 id="_6">编译和加载<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p>内核模块的编译使用内核构建系统 <code>kbuild</code>。在内核模块的目录下放置这样的 Makefile：</p>
<div class="language-makefile highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="cp">ifneq ($(KERNELRELEASE),)</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span>obj-m<span class="w"> </span>:<span class="o">=</span><span class="w"> </span>hello.o
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="c"># Otherwise we were called directly from the command line; invoke the kernel build system.</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="cp">else</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w">    </span>KERNELDIR<span class="w"> </span>?<span class="o">=</span><span class="w"> </span>/lib/modules/<span class="k">$(</span>shell<span class="w"> </span>uname<span class="w"> </span>-r<span class="k">)</span>/build
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="w">    </span>PWD<span class="w"> </span>:<span class="o">=</span><span class="w"> </span><span class="k">$(</span>shell<span class="w"> </span><span class="nb">pwd</span><span class="k">)</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="nf">default</span><span class="o">:</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="w">    </span><span class="k">$(</span>MAKE<span class="k">)</span><span class="w"> </span>-C<span class="w"> </span><span class="k">$(</span>KERNELDIR<span class="k">)</span><span class="w"> </span><span class="nv">M</span><span class="o">=</span><span class="k">$(</span>PWD<span class="k">)</span><span class="w"> </span>modules
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="cp">endif</span>
</span></code></pre></div>
<p>通过下面的命令编译：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="nv">KERNELDIR</span><span class="o">=</span>/path/to/kernel<span class="w"> </span>make
</span></code></pre></div>
<p>其中的原理涉及 GNU Make 扩展语法，暂略。大致过程是让 <code>make</code> 调用内核的 <code>Makefile</code>，使用内核构建系统的 <code>module</code> 目标来构建内核模块。编译完成的模块文件是 <code>hello.ko</code>。</p>
<div class="admonition todo">
<p class="admonition-title">Todo</p>
<p><code>martinezjavier/ldd3</code> 可以使用当前运行的 6.1 内核源码编译，却不能使用下载的 5.10 内核源码编译。看报错是缺了函数定义。不知道是 Debian Patch 还是内核 API 变动导致的。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>jit.c:96:47: error: implicit declaration of function ‘pde_data’ [-Werror=implicit-function-declaration]
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>96 |         return single_open(file, jit_fn_show, pde_data(inode));
</span></code></pre></div>
</div>
<p>几个实用工具：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>insmod modprobe rmmod lsmod
</span></code></pre></div>
<ul>
<li>加载内核模块时可以指定参数。</li>
<li><code>insmod</code> 通过 <code>sys_init_module</code> 系统调用加载模块，这会为模块分配一块内存区域，将模块的代码和数据复制到这个区域，然后进行解析模块的符号表等操作。</li>
<li>使用 <code>modprobe</code> 时，会检查模块中是否有内核符号表中的符号，如果没有，会自动加载依赖的模块。</li>
<li>如果内核检测到模块导出的设备等正在使用，会拒绝卸载模块。</li>
</ul>
<p>内核版本依赖：</p>
<ul>
<li>内核模块与特定内核版本紧密相关。构建内核模块时与 <code>vermagic.o</code> 链接，该文件中包含内核版本、处理器架构等信息，加载时会以此检查兼容性。</li>
<li>编写跨内核版本的模块时，与版本有关的接口，通常应当放置在一个头文件中用一层宏包装。</li>
</ul>
<h3 id="_7">内核符号表<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<ul>
<li>加载模块后，<code>EXPORT_SYMBOL()</code> 的符号进入内核符号表，其他模块可以使用。</li>
<li><code>EXPORT_SYMBOL_GPL()</code> 只允许 GPL 许可证的模块使用。</li>
</ul>
<h3 id="_8">准备工作<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<ul>
<li>使用 <code>MODULE_LICENSE()</code> 定义模块的许可证。如果未定义，内核会认为是专有的。加载这样的模块时，会有 <code>taint</code> 警告。</li>
</ul>
<h3 id="_9">初始化和关闭<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<div class="language-c highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">__init</span><span class="w"> </span><span class="nf">init_func</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="p">{</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="p">}</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="n">module_init</span><span class="p">(</span><span class="n">init_func</span><span class="p">);</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="n">module_exit</span><span class="p">(</span><span class="n">exit_func</span><span class="p">);</span>
</span></code></pre></div>
<p>初始化函数向系统注册一些设备。注册可能失败，因此需要检查返回值。失败时，可能继续执行但提供有限的功能，也可能直接退出，此时要注意清理已经注册的资源，这些编程经常使用 <code>goto</code> 语句。</p>
<p>函数声明中的 <code>__init</code> 和 <code>__exit</code> 具有特定功能和作用，使用时需要注意。比如 <code>__init</code> 在模块加载后会被丢弃，<code>__exit</code> 会放在特殊的段中，只能在模块卸载时调用请，其他情况下产生错误。</p>
<p>需要考虑模块加载时的竞争条件，可能初始化函数尚未执行完毕，就会有对模块的访问。因此模块内部的初始化应当在注册设备之前完成。</p>
<h3 id="_10">模块参数<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<p>模块参数可以在命令行中指定，如：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>insmod<span class="w"> </span>hello.ko<span class="w"> </span><span class="nv">howmany</span><span class="o">=</span><span class="m">3</span><span class="w"> </span><span class="nv">whom</span><span class="o">=</span><span class="s2">&quot;Mom&quot;</span>
</span></code></pre></div>
<p>也可以在 <code>/etc/modules.conf</code> 中配置。</p>
<p>模块参数不支持浮点数。</p>
<p>在模块中声明参数：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">howmany</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="n">module_param</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">);</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="n">module_param_array</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">num</span><span class="p">,</span><span class="w"> </span><span class="n">perm</span><span class="p">);</span>
</span></code></pre></div>
<p>所有模块参数都应该有默认值。<code>perm</code> 控制 <code>sysfs</code> 中参数的权限。</p>
<h3 id="_11">在用户空间内操作<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h3>
<p><code>libusb</code> 就是一个实现在用户空间的 USB 驱动。实现在用户空间有一些好处，比如可以使用标准库、调试过程更简单等。但这也有很多限制，比如网络接口、块设备都无法在用户空间实现，DMA 受限，速度较慢等。</p>
<h2 id="_12">第三章：字符设备<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h2>
<p>本章讲解 Simple Character Utility for Loading Localities (scull) 设备的实现。它操作一块内存，表现为一个字符设备。</p>
<h3 id="scull">scull 的设计<a class="headerlink" href="#scull" title="Permanent link">&para;</a></h3>
<p>它将提供下列设备：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>scull0-3
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>scullpipe0-3
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>scullsingle
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>scullpriv
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>sculluid
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>scullwuid
</span></code></pre></div>
<h3 id="_13">主要和次要设备号<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>在 <code>/dev</code> 中使用 <code>ls -l</code> 会发现原先显示文件大小的地方被设备号占据。一般来说，主设备号标识管理该设备的驱动（现在 Linux 允许多个驱动共享一个主设备号），次设备号标识设备的实例。</p>
<p>常用固定设备号见内核文档 <code>devices.txt</code>。可以在 <code>/proc/devices</code> 中查看当前系统中注册的设备。</p>
<p>设备号存储在 <code>dev_t</code> 类型中，使用宏操作它：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">MAJOR</span><span class="p">(</span><span class="kt">dev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">);</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="n">MINOR</span><span class="p">(</span><span class="kt">dev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">);</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="n">MKDEV</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">major</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">minor</span><span class="p">);</span>
</span></code></pre></div>
<p>设备号相关函数：</p>
<div class="language-c highlight"><span class="filename">linux/fs.h</span><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="c1">//int register_chrdev_region(dev_t first, unsigned int count, const char *name);</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="kt">int</span><span class="w"> </span><span class="nf">alloc_chrdev_region</span><span class="p">(</span><span class="kt">dev_t</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">firstminor</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">);</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">unregister_chrdev_region</span><span class="p">(</span><span class="kt">dev_t</span><span class="w"> </span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span></code></pre></div>
<p>拿到设备号后，还需要将设备号与驱动内部实现硬件操作的函数关联起来。</p>
<h3 id="_14">一些重要的数据结构<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p><code>file_operations</code></p>
<ul>
<li>定义于 <code>linux/fs.h</code>，包含了设备驱动的操作函数指针。每个打开的文件 <code>file</code> 都含有 <code>f_op</code> 指向文件操作相关的系统调用，实现 <code>open</code>、<code>read</code> 等操作。</li>
<li><code>struct module *owner</code> 指向持有这个结构的模块，避免模块在使用时被卸载。</li>
</ul>
<div class="language-c highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="n">loff_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">llseek</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">open</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">)</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">ioctl</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">inode</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="p">)</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="p">...</span>
</span></code></pre></div>
</li>
<li>
<p><code>file</code></p>
<ul>
<li>定义于 <code>linux/fs.h</code>，与标准库中的 <code>FILE</code> 不同，表示打开的文件的描述符。<code>open</code> 时创建，传给每个用到的函数，最后 <code>close</code> 时释放。</li>
</ul>
<div class="language-c highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="kt">mode_t</span><span class="w"> </span><span class="n">f_mode</span><span class="p">;</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="n">loff_t</span><span class="w"> </span><span class="n">f_pos</span><span class="p">;</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="o">*</span><span class="n">f_op</span><span class="p">;</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="p">...</span>
</span></code></pre></div>
</li>
<li>
<p><code>inode</code></p>
<ul>
<li>一个文件可以有多个 <code>file</code> 描述符，但都指向同一个 <code>inode</code>。</li>
</ul>
<div class="language-c highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kt">dev_t</span><span class="w"> </span><span class="n">i_rdev</span><span class="p">;</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="o">*</span><span class="n">i_cdev</span><span class="p">;</span>
</span></code></pre></div>
</li>
</ul>
<h3 id="_15">注册字符设备<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p>先初始化，再注册：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="o">*</span><span class="n">my_cdev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cdev_alloc</span><span class="p">();</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="n">my_cdev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">my_fops</span><span class="p">;</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">cdev_init</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="o">*</span><span class="n">cdev</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">file_operations</span><span class="w"> </span><span class="o">*</span><span class="n">fops</span><span class="p">);</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="n">my_cdev</span><span class="o">-&gt;</span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">THIS_MODULE</span><span class="p">;</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="kt">int</span><span class="w"> </span><span class="nf">cdev_add</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="kt">dev_t</span><span class="w"> </span><span class="n">num</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="kt">void</span><span class="w"> </span><span class="nf">cdev_del</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="o">*</span><span class="n">dev</span><span class="p">);</span>
</span></code></pre></div>
<h3 id="_16">打开和释放<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p><code>open</code> 的工作：</p>
<ul>
<li>检查设备相关错误。</li>
<li>如果第一次打开，初始化设备。</li>
<li>必要时更新 <code>f_op</code>。</li>
<li>分配并填充 <code>filp-&gt;private_data</code> 中的结构。</li>
</ul>
<p><code>release</code> 的工作：</p>
<ul>
<li>释放 <code>open</code> 分配的内存。</li>
<li>再最后一个文件描述符关闭时，关闭设备。</li>
<li>不是每个 <code>close</code> 调用都会导致 <code>release</code> 调用，内核做了引用计数，因此 <code>dup</code> 和 <code>fork</code> 能安全使用文件。</li>
<li>但每次 <code>close</code> 时总会调用 <code>flush</code>。</li>
</ul>
<p>杂项：</p>
<ul>
<li><code>container_of(pointer, container_type, container_field)</code> 宏，定义于 <code>linux/kernel.h</code>，用于从结构体的成员指针获取结构体指针。</li>
</ul>
<h3 id="scull_1">scull 的内存使用<a class="headerlink" href="#scull_1" title="Permanent link">&para;</a></h3>
<div class="language-c highlight"><span class="filename">linux/slab.h</span><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">kmalloc</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">gfp_t</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">kfree</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
</span></code></pre></div>
<h3 id="_17">读和写<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<div class="language-c highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">read</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">offp</span><span class="p">);</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">write</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">offp</span><span class="p">);</span>
</span></code></pre></div>
<p>注意缓冲区是用户空间地址，无法被内核程序直接访问。有几个原因：</p>
<ul>
<li>根据体系结构的不同，用户空间的地址可能在内核空间中无效。</li>
<li>即使是同一个地址，用户空间内存是分页的，可能不在 RAM 中，会让内核产生段错误。</li>
<li>安全问题。</li>
</ul>
<div class="language-c highlight"><span class="filename">asm/uaccess.h</span><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">copy_to_user</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="nf">copy_from_user</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">from</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">n</span><span class="p">);</span>
</span></code></pre></div>
<p>拷贝时进程可能被 sleep（等待页从磁盘加载到内存），因此需要考虑并发和 reentrant。</p>
<p><a class="glightbox" href="../ldd3.assets/ldd_ch3_dev_read.webp" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="ldd_ch3_dev_read" src="../ldd3.assets/ldd_ch3_dev_read.webp" /></a></p>
<p><code>read</code> 函数的返回值：</p>
<ul>
<li>与要求的字节数相同，表示成功。</li>
<li>小于要求的字节数，有多种原因。一般情况下，用户程序会再次尝试，直到传输完成。</li>
<li>0，表示到达文件尾。</li>
<li>负数，表示错误。</li>
</ul>
<p>此外还有当前没有数据，但马上会有数据的情况，在后文讨论阻塞时详细说明。</p>
<p><code>write</code> 函数返回值和 <code>read</code> 一致。</p>
<p>它们有向量版本：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">readv</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">iovec</span><span class="w"> </span><span class="o">*</span><span class="n">iov</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">pos</span><span class="p">);</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="kt">ssize_t</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">writev</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">iovec</span><span class="w"> </span><span class="o">*</span><span class="n">iov</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="n">loff_t</span><span class="w"> </span><span class="o">*</span><span class="n">pos</span><span class="p">);</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a><span class="k">struct</span><span class="w"> </span><span class="nc">iovec</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">__user</span><span class="w"> </span><span class="o">*</span><span class="n">iov_base</span><span class="p">;</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5" href="#__codelineno-21-5"></a><span class="w">    </span><span class="n">__kernel_size_t</span><span class="w"> </span><span class="n">iov_len</span><span class="p">;</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6" href="#__codelineno-21-6"></a><span class="p">};</span>
</span></code></pre></div>
<h3 id="_18">使用新设备<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p>可以用它吃满内存：</p>
<div class="language-shell highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>cp<span class="w"> </span>/dev/zero<span class="w"> </span>/dev/scull0
</span></code></pre></div>
<p>使用 <code>strace</code> 可以查看驱动中的系统调用。</p>
<h2 id="_19">第四章：调试技术<a class="headerlink" href="#_19" title="Permanent link">&para;</a></h2>
<h3 id="_20">内核调试支持<a class="headerlink" href="#_20" title="Permanent link">&para;</a></h3>
<p>自行编译内核，启用一般发行版自带内核没有启用的调试选项。</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>CONFIG_DEBUG_KERNEL
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>CONFIG_DEBUG_SLAB
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>CONFIG_DEBUG_PAGEALLOC
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>CONFIG_DEBUG_SPINLOCK
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>CONFIG_DEBUG_SPINLOCK_SLEEP
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>...
</span></code></pre></div>
<h3 id="_21">通过打印调试<a class="headerlink" href="#_21" title="Permanent link">&para;</a></h3>
<p>本节描述了内核日志系统，如何控制输出级别、控制台输出等。</p>
<p>介绍了通过宏包装的便捷调试函数：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="cp">#undef PDEBUG </span><span class="cm">/* undef it, just in case */</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="cp">#ifdef SCULL_DEBUG</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="cp"># ifdef __KERNEL__</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="cm">/* This one if debugging is on, and kernel space */</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="cp"># define PDEBUG(fmt, args...) printk( KERN_DEBUG &quot;scull: &quot; fmt, ## args)</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="cp"># else</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="cm">/* This one for user space */</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a><span class="cp"># define PDEBUG(fmt, args...) fprintf(stderr, fmt, ## args)</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="cp"># endif</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="cp">#else</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="cp"># define PDEBUG(fmt, args...) </span><span class="cm">/* not debugging: nothing */</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="cp">#endif</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="cp">#undef PDEBUGG</span>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="cp">#define PDEBUGG(fmt, args...) </span><span class="cm">/* nothing: it&#39;s a placeholder */</span>
</span></code></pre></div>
<div class="language-makefile highlight"><span class="filename">Makefile</span><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="c"># Comment/uncomment the following line to disable/enable debugging</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="nv">DEBUG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>y
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="c"># Add your debugging flag (or not) to CFLAGS</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="cp">ifeq ($(DEBUG),y)</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">  </span><span class="nv">DEBFLAGS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-O<span class="w"> </span>-g<span class="w"> </span>-DSCULL_DEBUG<span class="w"> </span><span class="c1"># &quot;-O&quot; is needed to expand inlines</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="cp">else</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="w">  </span><span class="nv">DEBFLAGS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>-O2
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="cp">endif</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="nv">CFLAGS</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">$(</span>DEBFLAGS<span class="k">)</span>
</span></code></pre></div>
<p>对于驱动还有一些函数：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">print_dev_t</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">dev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">);</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">format_dev_t</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">dev_t</span><span class="w"> </span><span class="n">dev</span><span class="p">);</span>
</span></code></pre></div>
<h3 id="_22">通过查询调试<a class="headerlink" href="#_22" title="Permanent link">&para;</a></h3>
<p><code>/proc</code> 文件系统中的每个文件都对应一个内核函数，产生该文件的内容。</p>
<div class="language-c highlight"><span class="filename">linux/proc_fs.h</span><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">read_proc</span><span class="p">)(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">page</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">eof</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">);</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="k">struct</span><span class="w"> </span><span class="nc">proc_dir_entry</span><span class="w"> </span><span class="o">*</span><span class="n">create_proc_read_entry</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="w">    </span><span class="kt">mode_t</span><span class="w"> </span><span class="n">mode</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">proc_dir_entry</span><span class="w"> </span><span class="o">*</span><span class="n">base</span><span class="p">,</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="w">    </span><span class="n">read_proc_t</span><span class="w"> </span><span class="o">*</span><span class="n">read_proc</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">);</span>
</span></code></pre></div>
<p>本节还介绍了 <code>seq_file</code> 接口。</p>
<h3 id="_23">通过观测调试<a class="headerlink" href="#_23" title="Permanent link">&para;</a></h3>
<p>本节介绍使用 <code>strace</code> 观察从用户空间发出的系统调用。</p>
<h3 id="_24">调试系统错误<a class="headerlink" href="#_24" title="Permanent link">&para;</a></h3>
<p>驱动发生错误时，可能导致使用该驱动的应用程序崩溃。此时动态分配到该上下文的数据可能丢失。程序崩溃时，内核会使用 <code>close</code> 关闭打开的文件，驱动程序可以收回 <code>open</code> 时分配的资源。</p>
<p>发生错误时，oops 消息打印处理器当前状态，如寄存器、EIP 等。本节用解引用 NULL 指针和缓冲区溢出两个例子演示了如何阅读 oops 消息。</p>
<p>还介绍了应对死机的方法。</p>
<h3 id="_25">调试器和相关工具<a class="headerlink" href="#_25" title="Permanent link">&para;</a></h3>
<p>介绍了使用 GDB、kdb 和其他各类工具调试内核的方法。由于没有自行编译内核，故略去。</p>
<p>有趣的是本节提及了内核为什么不提供调试器：</p>
<blockquote>
<p>The answer, quite simply, is that Linus does not
believe in interactive debuggers. He fears that they lead to poor fixes, those which
patch up symptoms rather than addressing the real cause of problems. Thus, no
built-in debuggers.</p>
</blockquote>
<h2 id="_26">第五章：并发和竞争条件<a class="headerlink" href="#_26" title="Permanent link">&para;</a></h2>
<h3 id="_27">并发及其管理<a class="headerlink" href="#_27" title="Permanent link">&para;</a></h3>
<p>硬件和很多软件资源都需要共享，一般使用锁机制来控制线程对共享资源的访问。</p>
<h3 id="semaphoremutex">旗语（Semaphore）和锁（Mutex）<a class="headerlink" href="#semaphoremutex" title="Permanent link">&para;</a></h3>
<p>旗语由一个整数值和 P、V 操作组成。当进程进入关键区时使用 P 操作将值减一，离开时使用 V 操作将值加一。当值为 0 时，进程会被阻塞。</p>
<p>将旗语整数值设置为 1 即可实现互斥锁，有时称为 mutex（即 mutual exclusion）。</p>
<p>在 Linux 中，V 对应 <code>up</code>，P 对应 <code>down</code>。源码目前位于 <a href="https://github.com/torvalds/linux/blob/master/include/linux/semaphore.h">linux/include/semaphore.h</a>。</p>
<p>此外，内核还提供</p>
<ul>
<li><code>rwsem</code> 读写锁，允许多个进程同时读，但只允许一个进程写。读写锁可能造成饥饿。</li>
<li><code>completion</code> 等待操作/子进程完成。</li>
<li><code>spinlock</code> 可以用在不可 sleep 的任务（如中断处理）中。需要获得锁的程序会不断轮训，因此称为自旋。这种情况容易造成死锁：持有锁的线程休眠，而需要锁的线程占用 CPU。因此，持有锁的进程应当执行原子化操作（期间不可 sleep）。</li>
<li><code>rwlock</code> 读写版的自旋锁。</li>
</ul>
<p>不同类型的锁针对不同的使用场景进行性能优化。</p>
<h3 id="_28">锁的常见错误<a class="headerlink" href="#_28" title="Permanent link">&para;</a></h3>
<p>略。</p>
<h3 id="_29">锁的替代品<a class="headerlink" href="#_29" title="Permanent link">&para;</a></h3>
<p>circular buffer、atomic variable、seqlock 等可以实现无锁数据结构。这些在驱动中很常见，比如网络适配器就使用 circular buffer。</p>
<p>此外还有 Read-Copy-Update 算法，类似于写时复制。</p>
<h2 id="_30">第六章：高级字符驱动操作<a class="headerlink" href="#_30" title="Permanent link">&para;</a></h2>
<h3 id="ioctl">ioctl<a class="headerlink" href="#ioctl" title="Permanent link">&para;</a></h3>
<p>略</p>
<h3 id="io">阻塞 I/O<a class="headerlink" href="#io" title="Permanent link">&para;</a></h3>
<p>当读写请求无法立即完成时，驱动会将进程置于睡眠状态。本节学习进程睡眠的相关知识。睡眠就是将进程标记为一种状态，从调度器的可运行队列中移除。</p>
<ul>
<li>可以在 <code>wait_queue_head_t</code> 中找到正在等待的进程并将其唤醒。</li>
<li>使用 <code>wait_event(queue, condition)</code> 使进程进入睡眠。</li>
<li>使用 <code>wake_up(queue)</code> 唤醒进程。</li>
<li><code>filp-&gt;f_flags</code> 有 <code>O_NONBLOCK</code> 标记，驱动可以考虑支持非阻塞 I/O。有些操作需要花费较长时间时可以使用非阻塞 I/O 返回 <code>EAGAIN</code>，让应用程序执行轮询。</li>
</ul>
<p>本节以一个阻塞 I/O 的例程结尾：</p>
<ul>
<li><code>read</code> 请求阻塞，直到硬件发出中断。作为中断处理的一部分，驱动唤醒等待的进程。</li>
<li>示例程序因为没有硬件，采用另一个进程生成数据并唤醒。</li>
<li>驱动具有读/写队列和缓冲区。</li>
</ul>
<p>本章剩余部分暂略。</p>
<h2 id="_31">第七章：时间、延迟与延后工作<a class="headerlink" href="#_31" title="Permanent link">&para;</a></h2>
<p>现实世界中的驱动还需要处理时间、内存管理和硬件访问等问题。</p>
<h3 id="_32">测量时间<a class="headerlink" href="#_32" title="Permanent link">&para;</a></h3>
<ul>
<li>使用内核的 <code>jiffies</code> 计数器：内核通过时钟中断来记录时间。时钟中断一般 1000 次/秒，可以通过 <code>HZ</code> 宏查看。时钟中断发生时，内核中的计数器 <code>jiffies</code> 就递增。</li>
<li>
<p>使用平台特定的寄存器：如果需要测量精确的时间，可以牺牲一些移植性，使用硬件的计时器。</p>
<ul>
<li>现代 CPU 的缓存、指令重排、分支预测等技术导致指令的时间无法预知。厂商通过提供时钟周期计数器解决高精度计时的问题。</li>
<li>这样的计时器因平台而异，可能 64 位或 32 位，可能只读或可写，可能无法从用户空间访问。</li>
<li>
<p>最有名的计时器是 x86 平台上的 TSC（Time Stamp Counter）。这个 64 位寄存器记录时钟周期数，可以从内核和用户空间访问。</p>
<div class="language-c highlight"><span class="filename">asm/msr.h</span><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="n">rdtsc</span><span class="p">(</span><span class="n">low32</span><span class="p">,</span><span class="w"> </span><span class="n">high32</span><span class="p">);</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="n">rdtscl</span><span class="p">(</span><span class="n">low32</span><span class="p">);</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="n">rdtscll</span><span class="p">(</span><span class="n">var64</span><span class="p">);</span>
</span></code></pre></div>
<p>举个例子，1 GHz 的 CPU 约 4.2 秒溢出一次 32 位计数器。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="n">unsinged</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">ini</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="p">;</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="n">rdtscl</span><span class="p">(</span><span class="n">ini</span><span class="p">);</span><span class="w"> </span><span class="n">rdtscl</span><span class="p">(</span><span class="n">end</span><span class="p">);</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="n">printk</span><span class="p">(</span><span class="s">&quot;Time: %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">ini</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>内核提供 <code>rdtsc</code> 的替代品 <code>get_cycles</code>，与平台无关。</p>
</li>
<li>
<p>本节还介绍了使用汇编内联代码的方法。下面这个宏在 MIPS 平台上实现了 <code>rdtsc</code>：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="cp">#define rdtscl(dest) \</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="cp">    __asm__ __volatile__(&quot;mfc0 %0,$9; nop&quot; : &quot;=r&quot; (dest))</span>
</span></code></pre></div>
</li>
<li>
<p>需要注意的是，平台特定的计时器在 SMP 系统上可能不同步。因此，需要关闭 Linux 的抢占机制，使得代码始终在同一个 CPU 上运行。</p>
</li>
<li>当前时间（Wall-clock time）：这个英文很形象，就是挂载墙上的钟的时间</li>
<li>对于驱动来说，一般不会使用这个时间。相关操作一般放到用户空间进行，如 <code>cron</code>。</li>
<li>内核提供了 <code>gettimeofday</code> 等函数，可以获取当前时间戳。</li>
</ul>
</li>
</ul>
<h3 id="_33">延迟执行<a class="headerlink" href="#_33" title="Permanent link">&para;</a></h3>
<p>略</p>
<h2 id="_34">第八章：分配内存<a class="headerlink" href="#_34" title="Permanent link">&para;</a></h2>
<h3 id="kmalloc"><code>kmalloc</code> 的细节<a class="headerlink" href="#kmalloc" title="Permanent link">&para;</a></h3>
<div class="language-c highlight"><span class="filename">linux/slab.h</span><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">kmalloc</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">);</span>
</span></code></pre></div>
<p>最常用的 <code>flags</code> 是 <code>GFP_KERNEL</code> 和 <code>GFP_ATOMIC</code>。前者表示为一个进程分配内存，可能会睡眠；后者可用于中断处理程序等不在进程上下文中的地方，且不会睡眠。</p>
<p>Linux 内核知道至少三种内存区域：DMA 使能内存、普通内存和高端内存。使用不同的 <code>flags</code> 可以指定从不同的区域分配内存。</p>
<ul>
<li>对于绝大多数平台，所有的内存都在 DMA 区域。</li>
<li>高端内存用于 x86 平台访问大量内存，需要建立特别的映射。</li>
<li>对于 NUMA 架构来说，会尽量分配本地内存。</li>
</ul>
<p>Linux 创建内存池，内存储中有固定大小的内存对象。分配内存时，从具有足够大的内存对象的池中取出内存，将其整块返回给调用者。内核编程者应当注意这一点，即分配的内存可能比请求的内存大。</p>
<p>本节没有深入探究具体机制。</p>
<h3 id="lookaside">Lookaside 缓存<a class="headerlink" href="#lookaside" title="Permanent link">&para;</a></h3>
<p>本章剩余部分略。</p>
<h2 id="_35">第九章：与硬件沟通<a class="headerlink" href="#_35" title="Permanent link">&para;</a></h2>
<h3 id="io-io">I/O 端口和 I/O 内存<a class="headerlink" href="#io-io" title="Permanent link">&para;</a></h3>
<p>这是两种不同的硬件访问方式：</p>
<ul>
<li>外围设备通过读/写其寄存器进行控制。每个设备有一些寄存器，在内存地址空间或 I/O 地址空间中连续分布。在硬件层面上，这些地址空间没有本质区别，都是向地址总线和控制总线发送信号，从数据总线读取或写入数据。<ul>
<li>有些 CPU（如 x86）则区分内存和 I/O 地址空间，使用专门的指令访问 I/O 端口。</li>
<li>有的 CPU 使用统一地址空间，没有 I/O 端口的概念。但大多数总线标准都有 I/O 端口的概念，这些 CPU 就通过内/外部电路模拟 I/O 端口。</li>
<li>Linux 也在所有平台上实现 I/O 端口的概念，即使底层 CPU 是统一地址空间。</li>
</ul>
</li>
<li>即使外围总线有 I/O 端口独立的地址空间，有些设备也不会把寄存器映射到 I/O 端口，而是映射到内存地址空间（比如 PCI 设备），因为这样：不需要专门的 CPU 指令、访问效率更高、编译器在寄存器分配和访存模式的选择上更灵活。</li>
</ul>
<p>I/O 操作有副作用，而内存没有：</p>
<ul>
<li>内存对 CPU 的性能非常重要，因此进行了很多优化：<ul>
<li>编译器可以进行缓存，使用寄存器或 CPU Cache，不进入物理内存。</li>
<li>编译和硬件执行时都可能发生重排。</li>
</ul>
</li>
<li>上面这些优化会造成 I/O 操作的 Bug，因此需要解决：<ul>
<li>缓存问题由 Linux 解决，在访问 I/O 区域时关闭所有硬件缓存。</li>
<li>
<p>编译器和硬件的重排优化通过 memory barrier 解决。</p>
<div class="language-c highlight"><span class="filename">linux/kernel.h</span><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">barrier</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span></code></pre></div>
<div class="language-c highlight"><span class="filename">asm/system.h</span><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">mb</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">wmb</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"> </span><span class="c1">// write memory barrier</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">rmb</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"> </span><span class="c1">// read memory barrier</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">smp_rmb</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span><span class="w"> </span><span class="c1">// read memory barrier for SMP</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="p">...</span>
</span></code></pre></div>
<p>值得注意的是，与同步有关的原语（如 spinlock 和 <code>atomic_t</code> 操作）也会起到 memory barrier 的作用。</p>
</li>
</ul>
</li>
</ul>
<div class="admonition bug">
<p class="admonition-title">Avoid normal pointers!</p>
<p>Use wrapper functions instead.</p>
</div>
<h3 id="io_1">使用 I/O 端口<a class="headerlink" href="#io_1" title="Permanent link">&para;</a></h3>
<div class="language-c highlight"><span class="filename">linux/ioport.h</span><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">resource</span><span class="w"> </span><span class="o">*</span><span class="n">request_region</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">);</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">release_region</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
</span></code></pre></div>
<p>在 <code>/proc/ioports</code> 中可以查看当前系统中的 I/O 端口。</p>
<p>硬件可能提供 8、16、32 位的端口，因此有不同的函数用于访问：</p>
<div class="language-c highlight"><span class="filename">asm/io.h</span><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="kt">unsigned</span><span class="w"> </span><span class="nf">inb</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">port</span><span class="p">);</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">outb</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">byte</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">port</span><span class="p">);</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="kt">unsigned</span><span class="w"> </span><span class="nf">inw</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">port</span><span class="p">);</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="kt">void</span><span class="w"> </span><span class="nf">outw</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">short</span><span class="w"> </span><span class="n">word</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">port</span><span class="p">);</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="p">...</span>
</span></code></pre></div>
<p>GNU C 提供了在用户空间访问 I/O 端口的方法（<code>&lt;sys/io.h&gt;</code>），但是需要系统调用来获取权限。</p>
<p>有些处理器还实现了一次向 I/O 端口读写多个字节的指令。</p>
<p>I/O 指令与处理器架构紧密相关，本节剩余部分概述了 Linux 支持的这些架构。</p>
<h3 id="io_2">一个 I/O 端口例子<a class="headerlink" href="#io_2" title="Permanent link">&para;</a></h3>
<p>大多数 I/O 引脚有两处控制：</p>
<ul>
<li>选择那些引脚用于输入/输出</li>
<li>读取或写入逻辑电平</li>
</ul>
<p>A simple <strong>parallel port</strong> driver.</p>
<ul>
<li>
<p><strong>I/O Ports</strong>：Two interface, begin at <code>0x378</code> and <code>0x278</code></p>
<p>Each interface consists of three ports:</p>
<div class="language-text highlight"><pre><span></span><code>- Port 1: Bidirectional data register
- Port 2: Read-only status register
- Port 3: Output-only control register
</code></pre></div>
</li>
<li>
<p><strong>Electrical Properties</strong>：</p>
<ul>
<li>Transistor-Transistor Logic (TTL), 0V and 5V.</li>
<li>25 Pins. Some of the pins are inverted.</li>
</ul>
</li>
</ul>
<p>The driver performs output operation as follows:</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="k">while</span><span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">){</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="w">    </span><span class="n">outb</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ptr</span><span class="o">++</span><span class="p">),</span><span class="w"> </span><span class="n">port</span><span class="p">);</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="w">    </span><span class="n">wmb</span><span class="p">();</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="using-io-memory">Using I/O Memory<a class="headerlink" href="#using-io-memory" title="Permanent link">&para;</a></h3>
<p>I/O memory includes: memory-mapped <strong>registers</strong> and device memory.</p>
<p>Access through <strong>page tables</strong>? Depending on the arch and bus used:</p>
<ul>
<li>Through page table: call <code>ioremap</code> before doing I/O. Kernel arrange for physical address to be visible from driver.</li>
<li>Not through page table: like I/O ports.</li>
</ul>
<p>Steps before access I/O memory:</p>
<ul>
<li>
<p>Allocation:</p>
<div class="language-c highlight"><span class="filename">linux/ioport.h</span><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">resource</span><span class="w"> </span><span class="o">*</span><span class="n">request_mem_region</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">len</span><span class="p">,</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="w">                            </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">);</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">release_mem_region</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>Set up mapping: functions used to assign <strong>virtual addresses to I/O memory regions</strong></p>
<div class="language-c highlight"><span class="filename">asm/io.h</span><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">ioremap</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">phys_addr</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">ioremap_nocache</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">phys_addr</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="kt">void</span><span class="w"> </span><span class="nf">iounmap</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</span></code></pre></div>
</li>
<li>
<p>Accessor: in <code>asm/io.h</code></p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">ioread8</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">ioread16</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">ioread32</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="p">...</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="kt">void</span><span class="w"> </span><span class="n">iowrite8</span><span class="p">(</span><span class="n">u8</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="p">...</span>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="c1">// repeat</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="kt">void</span><span class="w"> </span><span class="n">ioread8_rep</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="kt">void</span><span class="w"> </span><span class="nf">iowrite8_rep</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="p">...</span>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="c1">// block</span>
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a><span class="kt">void</span><span class="w"> </span><span class="n">memset_io</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">u8</span><span class="w"> </span><span class="n">value</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span><span id="__span-39-13"><a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a><span class="kt">void</span><span class="w"> </span><span class="nf">memcpy_fromio</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">dest</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span><span id="__span-39-14"><a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a><span class="kt">void</span><span class="w"> </span><span class="nf">memcpy_toio</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">dest</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span></code></pre></div>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="k">while</span><span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">){</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="w">    </span><span class="n">iowrite8</span><span class="p">(</span><span class="o">*</span><span class="n">prt</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">);</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="w">    </span><span class="n">wmb</span><span class="p">();</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="p">}</span>
</span></code></pre></div>
</div>
</li>
</ul>
<p>Ports as I/O memroy: makes I/O ports appear to be I/O memory</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">ioport_map</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">count</span><span class="p">);</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">ioport_unmap</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="p">);</span>
</span></code></pre></div>
<div class="admonition note">
<p class="admonition-title">Industry Standard Architecture (ISA)</p>
<p>The term "ISA" used in this chapter does not refer to Instruction Set Architecture, but is a <strong>bus architecture</strong>.</p>
<p>See:</p>
<ul>
<li><a href="http://www.linux-tutorial.info/?page_id=267">Industry Standard Architecture ISA | The Linux Tutorial</a>.</li>
<li><a href="https://en.wikipedia.org/wiki/Industry_Standard_Architecture">Industry Standard Architecture - Wikipedia</a></li>
</ul>
</div>
<h2 id="_36">第十章：中断处理<a class="headerlink" href="#_36" title="Permanent link">&para;</a></h2>
<h2 id="_37">第十一章：内核中的数据类型<a class="headerlink" href="#_37" title="Permanent link">&para;</a></h2>
<h2 id="pci">第十二章：PCI 驱动<a class="headerlink" href="#pci" title="Permanent link">&para;</a></h2>
<h2 id="usb">第十三章：USB 驱动<a class="headerlink" href="#usb" title="Permanent link">&para;</a></h2>
<h2 id="linux">第十四章：Linux 设备模型<a class="headerlink" href="#linux" title="Permanent link">&para;</a></h2>
<p>2.5 版本内核的开发工作主要集中在创建统一的设备模型上。</p>
<p><a class="glightbox" href="../ldd3.assets/ldd_ch14_1.webp" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="ldd_ch14_1" src="../ldd3.assets/ldd_ch14_1.webp" /></a></p>
<p>统一的设备模型为下列功能提供基础：</p>
<ul>
<li>电源管理</li>
<li>用户空间：<code>sysfs</code> 可以查看和修改设备状态</li>
<li>热插拔</li>
<li>设备类别（classes）</li>
<li>对象生命周期</li>
</ul>
<h3 id="kobject-kset"><code>Kobject</code> 和 <code>Kset</code><a class="headerlink" href="#kobject-kset" title="Permanent link">&para;</a></h3>
<p>在了解具体实现前，先看看 <code>kobject</code> 是如何被使用的。一般情况下不会使用独立的 <code>kobject</code>，而是将其嵌入到其他结构体中。用面向对象的思想理解，可以认为 <code>kobject</code> 是一个基类，其他结构体是派生类。</p>
<ul>
<li>从其他结构体的 <code>.kobj</code> 成员可以访问 <code>kobject</code>，对 <code>kobject</code> 使用 <code>container_of()</code> 宏可以获取到其他结构体。</li>
<li><code>kobject</code> 提供：引用计数、<code>sysfs</code> 表示、数据结构胶水和热插拔处理等功能。</li>
<li>常见使用步骤：<ul>
<li>将 <code>kobject</code> 作为嵌入结构体的一部分，使用 <code>memset()</code> 初始化为 0。</li>
<li><code>kobject_init()</code> 将引用计数置 1。</li>
<li><code>kobject_set_name()</code> 设置名字，用于 <code>sysfs</code>。</li>
<li>总的来说，创建者需要设置其 <code>ktype</code>、<code>parent</code> 和 <code>kset</code> 成员。</li>
</ul>
</li>
<li>
<p>引用计数：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="o">*</span><span class="n">kobject_get</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="o">*</span><span class="n">kobj</span><span class="p">);</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">kobject_put</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="o">*</span><span class="n">kobj</span><span class="p">);</span>
</span></code></pre></div>
<p>在很多情况下，引用计数并不能完全解决问题，比如 <code>kobject</code> 作为内核模块的一部分，如果它在被使用，那么就不能卸载对应的模块。很多结构体包含 <code>struct module</code> 指针，在维护引用计数时检查：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="o">*</span><span class="n">cdev_get</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">cdev</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="p">{</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">module</span><span class="w"> </span><span class="o">*</span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="o">*</span><span class="n">kobj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">;</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">owner</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">owner</span><span class="p">))</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="w">    </span><span class="n">kobj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">kobject_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">);</span>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">kobj</span><span class="p">)</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="w">        </span><span class="n">module_put</span><span class="p">(</span><span class="n">owner</span><span class="p">);</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">kobj</span><span class="p">;</span>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="p">}</span>
</span></code></pre></div>
</li>
</ul>
<div class="language-c highlight"><span class="filename">linux/kobject.h</span><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">;</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobject</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kset</span><span class="w"> </span><span class="o">*</span><span class="n">kset</span><span class="p">;</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kobj_type</span><span class="w"> </span><span class="o">*</span><span class="n">ktype</span><span class="p">;</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sysfs_dirent</span><span class="w"> </span><span class="o">*</span><span class="n">sd</span><span class="p">;</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">kref</span><span class="w"> </span><span class="n">kref</span><span class="p">;</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">list_head</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a><span class="p">};</span>
</span></code></pre></div>
<h2 id="dma">第十五章：内存映射与 DMA<a class="headerlink" href="#dma" title="Permanent link">&para;</a></h2>
<blockquote>
<p>当我们进入复杂和性能关键的领域时，虚拟内存系统是 Linux 内核中非常有趣的一部分。</p>
<p>本节覆盖三个部分：</p>
<ul>
<li><code>mmap()</code> 系统调用如何将设备的内存映射到进程用户空间</li>
<li><code>get_user_pages()</code> 如何直接访问用户空间页面</li>
<li>DMA</li>
</ul>
</blockquote>
<h3 id="linux_1">Linux 内存管理<a class="headerlink" href="#linux_1" title="Permanent link">&para;</a></h3>
<p>在 Linux 内核中，在什么情况下应该使用什么类型的地址并不总是显而易见。</p>
<ul>
<li>用户虚拟地址</li>
<li>物理地址</li>
<li>
<p>总线地址</p>
<p>有些体系结构提供了 IOMMU（Input/Output Memory Management Unit）来处理总线地址到物理地址的映射。IOMMU 提供许多便利，比如通过地址重映射，设备看到的地址空间是连续的，但操作系统可能无法找到一块足够大的连续物理内存空间来满足需求，IOMMU 将这些连续的设备地址动态映射到实际物理内存中分散的缓冲区。</p>
<p>IOMMU 简化了设备驱动程序的设计。</p>
</li>
<li>
<p>内核逻辑地址</p>
<p>某些物理地址映射为内核逻辑地址，具有<strong>固定的偏移量</strong>。<code>kmalloc()</code> 返回这类地，通常存储为 <code>unsigned long</code> 或 <code>void *</code>。</p>
</li>
<li>
<p>内核虚拟地址</p>
<p>与内核逻辑地址不同，不一定是线性、一对一的映射。<code>vmalloc()</code> 和 <code>kmap()</code> 返回这类地址。</p>
</li>
</ul>
<p><code>&lt;asm/page.h&gt;</code> 一些宏：</p>
<ul>
<li><code>__pa()</code>：返回物理地址</li>
<li><code>__va()</code>：返回虚拟地址，仅对低地址有效</li>
<li><code>PAGE_SIZE</code></li>
<li><code>PAGE_SHIFT</code></li>
</ul>
<div class="admonition info">
<p class="admonition-title">高/低内存</p>
<p>见 <a href="https://www.kernel.org/doc/html/v5.18/translations/zh_CN/vm/highmem.html">高内存处理 — The Linux Kernel documentation</a>。</p>
<p>当物理内存的大小接近或超过虚拟内存的最大大小时，内核不可能在任何时候都保持所有可用的物理内存的映射。传统分配方式中，较低的一段地址空间被永久映射，而较高的一段地址空间则被动态映射。这就是高、低内存的由来。</p>
<p>比如，32 位体系结构的虚拟内存空间为 4GB，如果物理内存有 8GB，那么内核就无法将所有物理内存映射到虚拟内存中。</p>
<p>在 64 位体系结构上，高内存不再是问题，可用的地址空间达到了 16EB。</p>
</div>
<p>下列内容在 Linux Kernel Development 中已学习过，这里不再赘述：</p>
<ul>
<li>物理内存页面映射和 <code>struct page</code></li>
<li>页表</li>
<li>VMA 和 <code>struct vm_area_struct</code></li>
<li>进程内存映射 <code>struct mm_struct</code>，<code>current-&gt;mm</code></li>
</ul>
<h3 id="mmap"><code>mmap()</code> 设备操作<a class="headerlink" href="#mmap" title="Permanent link">&para;</a></h3>
<ul>
<li><code>/proc/*/maps</code></li>
<li><code>/proc/iomem</code></li>
</ul>
<p>使用 <code>mmap()</code> 的实例：</p>
<ul>
<li>X Server 映射显卡的显存，比 <code>lseek()</code>/<code>write()</code> 更加高效</li>
<li>PCI 设备将控制寄存器映射到内存地址，比 <code>ioctl()</code> 更加高效</li>
</ul>
<p>系统调用 <code>mmap()</code> (2)</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="n">mmap</span><span class="w"> </span><span class="p">(</span><span class="n">caddr_t</span><span class="w"> </span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">prot</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="kt">off_t</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span>
</span></code></pre></div>
<p>会调用作为 <code>file_operations</code> 结构的一部分的 <code>mmap()</code></p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="kt">int</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">mmap</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="p">);</span>
</span></code></pre></div>
<p>作为驱动程序的实现者，我们收到 <code>vma</code>，为相应地址范围构建页表，并视情况提供 <code>vma-&gt;vm_ops</code> 即可。</p>
<p>构建页表有两种方法：</p>
<ul>
<li>
<p><code>remap_pfn_range()</code>、<code>io_remap_page_range()</code>：它们接收 <code>vma</code>、<code>virt_addr</code> 和 <code>pfn</code> 等参数，建立对应的映射关系。前者用于处理真实内存的映射，后者用于处理物理地址为 I/O 内存的映射。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">simple_remap_mmap</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="p">)</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="p">{</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">remap_pfn_range</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span><span class="w"> </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span><span class="w"> </span><span class="n">vm</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span><span class="p">,</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="w">    </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="w">    </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">))</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="w">    </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">simple_remap_vm_ops</span><span class="p">;</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="w">    </span><span class="n">simple_vma_open</span><span class="p">(</span><span class="n">vma</span><span class="p">);</span>
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="p">}</span>
</span></code></pre></div>
</li>
<li>
<p><code>nopage()</code> 逐页映射，更加灵活，常用于系统调用 <code>mremap()</code>。当用户进程访问 VMA 中不存在于内存中的页面时，将调用 <code>nopage()</code>。</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">simple_nopage_mmap</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">file</span><span class="w"> </span><span class="o">*</span><span class="n">filp</span><span class="p">,</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="p">)</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="p">{</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">;</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">__pa</span><span class="p">(</span><span class="n">high_memory</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">O_SYNC</span><span class="p">))</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="w">    </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">VM_IO</span><span class="p">;</span>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6" href="#__codelineno-48-6"></a><span class="w">    </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">VM_RESERVED</span><span class="p">;</span>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7" href="#__codelineno-48-7"></a><span class="w">    </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">simple_nopage_vm_ops</span><span class="p">;</span>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8" href="#__codelineno-48-8"></a><span class="w">    </span><span class="n">simple_vma_open</span><span class="p">(</span><span class="n">vma</span><span class="p">);</span>
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9" href="#__codelineno-48-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10" href="#__codelineno-48-10"></a><span class="p">}</span>
</span></code></pre></div>
<p>相应 <code>vm_operations_struct</code> 中的 <code>nopage()</code> 直接操作内存页面计数：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">simple_vma_nopage</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="o">*</span><span class="n">vma</span><span class="p">,</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">type</span><span class="p">)</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="p">{</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4" href="#__codelineno-49-4"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">*</span><span class="n">pageptr</span><span class="p">;</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5" href="#__codelineno-49-5"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">;</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6" href="#__codelineno-49-6"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">physaddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7" href="#__codelineno-49-7"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">pageframe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">physaddr</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">PAGE_SHIFT</span><span class="p">;</span>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8" href="#__codelineno-49-8"></a>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9" href="#__codelineno-49-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">pfn_valid</span><span class="p">(</span><span class="n">pageframe</span><span class="p">))</span>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10" href="#__codelineno-49-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">NOPAGE_SIGBUS</span><span class="p">;</span>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11" href="#__codelineno-49-11"></a><span class="w">    </span><span class="n">pageptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pfn_to_page</span><span class="p">(</span><span class="n">pageframe</span><span class="p">);</span>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12" href="#__codelineno-49-12"></a><span class="w">    </span><span class="n">get_page</span><span class="p">(</span><span class="n">pageptr</span><span class="p">);</span>
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13" href="#__codelineno-49-13"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
</span><span id="__span-49-14"><a id="__codelineno-49-14" name="__codelineno-49-14" href="#__codelineno-49-14"></a><span class="w">        </span><span class="o">*</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VM_FAULT_MINOR</span><span class="p">;</span>
</span><span id="__span-49-15"><a id="__codelineno-49-15" name="__codelineno-49-15" href="#__codelineno-49-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">pageptr</span><span class="p">;</span>
</span><span id="__span-49-16"><a id="__codelineno-49-16" name="__codelineno-49-16" href="#__codelineno-49-16"></a><span class="p">}</span>
</span></code></pre></div>
</li>
</ul>
<p>一般来说，设备内存不应该被 cache，见 <code>pgprot_noncached</code>。</p>
<div class="admonition todo">
<p class="admonition-title">重映射章节</p>
</div>
<h3 id="io_3">执行直接 I/O<a class="headerlink" href="#io_3" title="Permanent link">&para;</a></h3>
<p>大多数 I/O 操作都被内核缓存。</p>
<p>实现直接 I/O 的关键在于 <code>get_user_pages()</code>：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="kt">int</span><span class="w"> </span><span class="nf">get_user_pages</span><span class="p">(</span><span class="k">struct</span><span class="w"> </span><span class="nc">task_struct</span><span class="w"> </span><span class="o">*</span><span class="n">tsk</span><span class="p">,</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">mm_struct</span><span class="w"> </span><span class="o">*</span><span class="n">mm</span><span class="p">,</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="w">    </span><span class="c1">// 用户空间缓冲区起始地址和长度（按页对齐）</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">start</span><span class="p">,</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">len</span><span class="p">,</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6" href="#__codelineno-50-6"></a><span class="w">    </span><span class="c1">// 权限</span>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7" href="#__codelineno-50-7"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">write</span><span class="p">,</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8" href="#__codelineno-50-8"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">force</span><span class="p">,</span>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9" href="#__codelineno-50-9"></a><span class="w">    </span><span class="c1">// 返回 pin 在内存中的页面</span>
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10" href="#__codelineno-50-10"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">page</span><span class="w"> </span><span class="o">**</span><span class="n">pages</span><span class="p">,</span>
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11" href="#__codelineno-50-11"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">vm_area_struct</span><span class="w"> </span><span class="o">**</span><span class="n">vmas</span><span class="p">);</span>
</span></code></pre></div>
<p>2.6 引入了异步 I/O，用户空间可以发起 I/O 而无需等待。驱动程序可以选择是否支持异步 I/O。其中，块设备和网络设备的 I/O 总是异步的，由内核中更高层次的代码提供支持（设置缓冲区等），驱动程序不需要管。见 <code>linux/aio.h</code>。</p>
<h3 id="dma_1">DMA<a class="headerlink" href="#dma_1" title="Permanent link">&para;</a></h3>
<p>外围设备可以通过 DMA 向内存传输数据，处理器无需参与。</p>
<p>两种输入方式：</p>
<ul>
<li>
<p>程序请求：</p>
<ol>
<li><code>read()</code> 调用，驱动程序分配 DMA 缓冲，令硬件向缓冲区写入，进程休眠。</li>
<li>硬件向缓冲区写入，完成时发起中断。</li>
<li>中断处理程序获得数据，唤醒进程。</li>
</ol>
</li>
<li>
<p>硬件异步推送（异步使用 DMA）：</p>
<ol>
<li>硬件发起中断，告知新数据到达。</li>
<li>中断处理程序分配缓冲区，告知硬件传输数据。</li>
<li>硬件向缓冲区写入，完成时发起中断。</li>
<li>中断处理程序获得数据，唤醒进程，管理簿记。</li>
</ol>
</li>
</ul>
<p>以网卡为例：网卡使用 DMA ring buffer，收到的包放在下一个可用的 buffer 中，并发起中断，由驱动程序将包传递给内核其他部分，并放置新的 DMA buffer。</p>
<h4 id="dma_2">分配 DMA 缓冲区<a class="headerlink" href="#dma_2" title="Permanent link">&para;</a></h4>
<p>需要考虑设备能处理的地址范围，使用 <code>GFP_DMA</code> 从 <code>kmalloc()</code> 或 <code>get_free_pages()</code> 调用中获得 DMA 区域的页面。</p>
<p>要求为连续物理页，因为设备在总线上使用物理地址传输。然而随着系统运行，内存逐渐碎片化。有几种方法：</p>
<ul>
<li>启动时使用 <code>mem=</code> 内核参数限制内核使用的内存范围，剩余的高内存即可被驱动程序作为缓冲区。</li>
<li>使用 <code>GFP_NOFAIL</code> 选项分配内存，但会给系统带来压力，可能导致系统锁死。</li>
<li>如果设备支持<strong>散射/聚集（scatter/gather）I/O</strong>，则可以将缓冲区分为多个部分。</li>
</ul>
<h4 id="dma_3">通用 DMA 层<a class="headerlink" href="#dma_3" title="Permanent link">&para;</a></h4>
<p>严格来说，设备使用的是总线地址而非物理地址，在某些平台上这两个地址间有映射关系。要编写一个通用的驱动程序是一件复杂的事情，因此 Linux 提供了通用 DMA 层，与总线和架构无关。</p>
<div class="admonition todo">
<p class="admonition-title">未完成</p>
</div>
<h2 id="_38">第十七章：网络驱动<a class="headerlink" href="#_38" title="Permanent link">&para;</a></h2>
<p>与上一节的块设备相比，网络设备有几个不同：</p>
<ul>
<li>
<p>在 <code>/dev</code> 下没有对应的文件。对于网络设备来说，文件操作没有意义。</p>
<p>尽管 Socket 仍然使用 <code>read/write</code> 操作，但 Socket 是软件层面的对象。</p>
<p>因此，网络设备存在自己的命名空间，提供另一套操作。</p>
</li>
<li>
<p>块设备<strong>被动地</strong>接受内核的请求，而网络设备<strong>主动地</strong>向内核发送数据。</p>
</li>
</ul>
<p>Linux 网络子系统被设计为与协议无关。</p>
<h3 id="snull"><code>snull</code> 的设计<a class="headerlink" href="#snull" title="Permanent link">&para;</a></h3>
<p>略</p>
<h3 id="_39">连接到内核<a class="headerlink" href="#_39" title="Permanent link">&para;</a></h3>
<p>作者建议阅读内核源码的顺序：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>loopback.c
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>plip.c
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>e100.c
</span></code></pre></div>
<h4 id="_40">设备注册<a class="headerlink" href="#_40" title="Permanent link">&para;</a></h4>
<p>与块设备和字符设备不同，网络设备<strong>不需要设备号，而是向全局网络设备列表中插入新的接口</strong>。每个接口用 <code>struct net_device</code> 结构表示，与其他内核对象一样使用引用计数来管理。该结构通过 <code>netdev_alloc()</code> 分配。</p>
<div class="language-c highlight"><span class="filename">linux/netdevice.h</span><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">net_device</span><span class="w"> </span><span class="o">*</span><span class="n">alloc_netdev</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">sizeof_priv</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">,</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">setup</span><span class="p">)(</span><span class="k">struct</span><span class="w"> </span><span class="nc">net_device</span><span class="w"> </span><span class="o">*</span><span class="p">));</span>
</span></code></pre></div>
<p>其中 <code>sizeof_priv</code> 是私有数据的大小。</p>
<p>完成设备创建和初始化后，将其传递给 <code>register_netdev()</code> 即可。</p>
<h4 id="_41">设备初始化<a class="headerlink" href="#_41" title="Permanent link">&para;</a></h4>
<p><code>ether_setup()</code> 初始化以太网设备的默认值，一般先用它初始化：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="n">ether_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="n">dev</span><span class="o">-&gt;</span><span class="n">open</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">snull_open</span><span class="p">;</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">IFF_NOARP</span><span class="p">;</span>
</span></code></pre></div>
<p>访问私有数据使用 <code>netdev_priv()</code>：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">snull_priv</span><span class="w"> </span><span class="o">*</span><span class="n">priv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span></code></pre></div>
<h4 id="_42">模块卸载<a class="headerlink" href="#_42" title="Permanent link">&para;</a></h4>
<p>取消注册，释放设备结构：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="n">snull_teardown_pool</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span></code></pre></div>
<p><code>free_netdev()</code> 后可能仍然存在（引用计数），但驱动不关心。</p>
<h3 id="net_device"><code>net_device</code> 结构详解<a class="headerlink" href="#net_device" title="Permanent link">&para;</a></h3>
<p>略</p>
<h4 id="_43">设备方法<a class="headerlink" href="#_43" title="Permanent link">&para;</a></h4>
<p>基础方法：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="n">open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="n">stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="n">hard_start_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="p">);</span><span class="w"> </span><span class="c1">// 发起包传输</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="n">hard_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">saddr</span><span class="p">,</span><span class="w"> </span><span class="n">len</span><span class="p">);</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="n">rebuild_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="n">tx_timeout</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="n">get_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="n">set_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">map</span><span class="p">);</span>
</span></code></pre></div>
<ul>
<li><code>skb</code> 是 Socket buffer</li>
</ul>
<p>可选方法：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="n">weight</span><span class="p">;</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="n">poll</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">quota</span><span class="p">);</span>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="n">poll_controller</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="n">do_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">ifr</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">);</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="n">set_multicast_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="n">set_mac_address</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="p">);</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7" href="#__codelineno-57-7"></a><span class="n">change_mtu</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">new_mtu</span><span class="p">);</span>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8" href="#__codelineno-57-8"></a><span class="n">header_cache</span><span class="p">(</span><span class="n">neigh</span><span class="p">,</span><span class="w"> </span><span class="n">hh</span><span class="p">);</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9" href="#__codelineno-57-9"></a><span class="n">header_cache_update</span><span class="p">(</span><span class="n">hh</span><span class="p">,</span><span class="w"> </span><span class="n">dev</span><span class="p">,</span><span class="w"> </span><span class="n">haddr</span><span class="p">);</span>
</span><span id="__span-57-10"><a id="__codelineno-57-10" name="__codelineno-57-10" href="#__codelineno-57-10"></a><span class="n">hard_header_parse</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="w"> </span><span class="n">haddr</span><span class="p">);</span>
</span></code></pre></div>
<h4 id="_44">辅助字段<a class="headerlink" href="#_44" title="Permanent link">&para;</a></h4>
<p>略</p>
<h3 id="_45">打开与关闭<a class="headerlink" href="#_45" title="Permanent link">&para;</a></h3>
<p>使用 <code>ifconfig</code> 为网络接口设置地址时，有两项任务：</p>
<ul>
<li>使用 <code>ioctl(SIOCSIFADDR)</code> 设置地址：没有驱动程序的参与，由内核执行。</li>
<li>使用 <code>ioctl(SIOCSIFFLAGS)</code> 设置标志 <code>IFF_UP</code>：驱动程序参与，调用 <code>open()</code>。<ul>
<li>和其他设备一样，请求各类资源（<code>requiest_region()</code> 等）。</li>
<li>从设备拷贝硬件地址（MAC）到 <code>dev-&gt;dev_addr</code>。</li>
<li>启动接口的传输队列，通过 <code>netif_start_queue()</code> 实现。</li>
</ul>
</li>
</ul>
<p>关闭端口时，调用 <code>stop()</code>。</p>
<h3 id="_46">包传输<a class="headerlink" href="#_46" title="Permanent link">&para;</a></h3>
<div class="admonition todo">
<p class="admonition-title">未完成</p>
</div>
<h3 id="_47">更改链路状态<a class="headerlink" href="#_47" title="Permanent link">&para;</a></h3>
<p>物理上的连接提供 carrier 状态，表明硬件存在。</p>
<p>驱动程序检测到 carrier 状态变化时，可以通过下面的接口改变链路状态：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="kt">void</span><span class="w"> </span><span class="nf">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="kt">void</span><span class="w"> </span><span class="nf">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="kt">int</span><span class="w"> </span><span class="nf">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span><span class="w"> </span><span class="c1">// test</span>
</span></code></pre></div>
<h4 id="rtnl">补充内容：RTNL<a class="headerlink" href="#rtnl" title="Permanent link">&para;</a></h4>
<div class="admonition quote">
<p class="admonition-title">Quote</p>
<ul>
<li><a href="https://netdevconf.info/2.2/papers/westphal-rtnlmutex-talk.pdf">RTNL mutex, the network stack big kernel lock - RedHat</a></li>
</ul>
</div>
<p>rtnetlink 是 netlink 子系统之一，自 Linux 2.2 加入内核，用于处理网络相关的配置。</p>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="June 27, 2025 08:26:17 UTC">June 27, 2025</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/" class="md-footer__link md-footer__link--prev" aria-label="Previous: 启动过程">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                启动过程
              </div>
            </div>
          </a>
        
        
          
          <a href="../%F0%9F%93%96%20Linux%20Kernel%20Development%20%283rd%29/" class="md-footer__link md-footer__link--next" aria-label="Next: 📖 Linux Kernel Development (3rd)">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                📖 Linux Kernel Development (3rd)
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      <a href="https://beian.miit.gov.cn/" target="_blank">浙ICP备2022036274号-1</a>
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://bowling233.com" target="_blank" rel="noopener" title="bowling233.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.07 4.93C17.22 3 14.66 1.96 12 2c-2.66-.04-5.21 1-7.06 2.93C3 6.78 1.96 9.34 2 12c-.04 2.66 1 5.21 2.93 7.06C6.78 21 9.34 22.04 12 22c2.66.04 5.21-1 7.06-2.93C21 17.22 22.04 14.66 22 12c.04-2.66-1-5.22-2.93-7.07M17 12v6h-3.5v-5h-3v5H7v-6H5l7-7 7.5 7H17Z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.copy", "content.code.select", "content.code.annotate", "navigation.footer", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.indexes", "navigation.tracking", "navigation.path", "navigation.top", "toc.follow", "content.action.edit", "search.suggest", "search.highlight", "search.share"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.alicdn.com/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://unpkg.com/tablesort/dist/tablesort.min.js"></script>
      
        <script src="../../../javascripts/tablesort.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>